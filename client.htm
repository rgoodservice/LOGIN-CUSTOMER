<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Client ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#0f172a;--card:#1e293b;--text:#e5eef7;--muted:#9fb0c6;--border:#2b3a4f;--accent:#3b82f6}
  body{font-family:ui-sans-serif,system-ui; background:linear-gradient(135deg,#0f172a 0%,#182235 100%); color:var(--text); padding:24px}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:rgba(30,41,59,.9); border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:14px}
  h1{font-size:22px;font-weight:800;margin-bottom:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
  th{background:rgba(59,130,246,.1);color:#b7cdfb}
  .muted{color:var(--muted)}
  .tr-soon{background:rgba(245,158,11,.08);}
  .tr-expired{background:rgba(239,68,68,.10);}
  .badge-expiry{padding:4px 8px;border-radius:999px;font-size:12px}
  .badge-soon{color:#f59e0b;background:rgba(245,158,11,.08)}
  .badge-expired{color:#ef4444;background:rgba(239,68,68,.10)}
  .alert-expiry{display:none;margin-bottom:12px;padding:12px;border:1px solid rgba(245,158,11,.4);background:rgba(245,158,11,.08);color:#f59e0b;border-radius:10px}
  .alert-expiry.show{display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üìã ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</h1>
    <div class="muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Äî ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div>
  </div>

  <div class="card">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: </label>
    <input id="companyCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC" style="text-transform:uppercase">
    <button id="btnSet">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div class="card">
    <div id="expiryAlert" class="alert-expiry"></div>
    <table>
      <thead>
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
          <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</th>
          <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="7" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL='https://qmugpalgcktfwixqepti.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const $=id=>document.getElementById(id);
const WARNING_DAYS=3;
function fmtDate(d){if(!d)return'‚Äî';const t=new Date(d);return isNaN(t)?d:t.toLocaleDateString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit'});}
function daysLeft(d){if(!d)return null;const dd=new Date(d);if(isNaN(dd))return null;const today=new Date();today.setHours(0,0,0,0);return Math.ceil((dd-today)/(1000*60*60*24));}

async function loadRows(c){
  const {data,error}=await sb.from('product_registrations').select('*').eq('company_code',c).order('created_at');
  if(error){$('tbody').innerHTML=`<tr><td colspan="7">${error.message}</td></tr>`;return;}
  const rows=data||[];let soon=0,exp=0;const alertBox=$('expiryAlert');
  $('tbody').innerHTML=rows.map((r,i)=>{
    const dl=daysLeft(r.expiry_date);let cls='',badge='';
    if(dl!==null){
      if(dl<=0){cls='tr-expired';badge='<span class="badge-expiry badge-expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>';exp++;}
      else if(dl<=WARNING_DAYS){cls='tr-soon';badge=`<span class="badge-expiry badge-soon">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${dl} ‡∏ß‡∏±‡∏ô</span>`;soon++;}
    }
    return `<tr class="${cls}">
      <td>${i+1}</td>
      <td>${r.company_code||'-'}</td>
      <td>${r.brand_name||'-'}</td>
      <td>${r.common_label||'-'}</td>
      <td>${r.registration_no||'-'}</td>
      <td>${r.license_no||'-'}</td>
      <td>${fmtDate(r.expiry_date)} ${badge}</td>
    </tr>`;
  }).join('');
  if(soon||exp){alertBox.classList.add('show');alertBox.innerHTML=`‚ö†Ô∏è ‡∏û‡∏ö ${exp?'‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß '+exp+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':''} ${soon?'‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‚â§3 ‡∏ß‡∏±‡∏ô) '+soon+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':''}`;}
  else{alertBox.classList.remove('show');alertBox.innerHTML='';}
}

$('btnSet').addEventListener('click',()=>{
  const c=$('companyCode').value.toUpperCase();
  if(!c) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  loadRows(c);
});

// ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏ö ?company=ABC ‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
document.addEventListener('DOMContentLoaded', ()=>{
  const c=new URLSearchParams(location.search).get('company');
  if(c){$('companyCode').value=c.toUpperCase();loadRows(c.toUpperCase());}
});
</script>
</body>
</html>
