<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Customer Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:rgba(30,41,59,.86); --mut:#94a3b8; --ink:#e2e8f0; --border:rgba(148,163,184,.25);
    --accent:#22d3ee; --accent-2:#60a5fa; --ok:#10b981; --warn:#f59e0b; --exp:#ef4444;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:"Prompt",ui-sans-serif,system-ui; color:var(--ink); background:
    radial-gradient(1000px 600px at 10% -10%, #0ea5a520 0%, transparent 60%),
    radial-gradient(800px 480px at 110% 0%, #38bdf820 0%, transparent 60%),
    var(--bg);}
  header{padding:20px 16px; border-bottom:1px solid var(--border); background:rgba(15,23,42,.6); backdrop-filter: blur(6px);}
  .brand{max-width:1000px;margin:0 auto;display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));}
  .container{max-width:1000px;margin:20px auto;padding:0 16px 28px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 6px 24px rgba(0,0,0,.25); padding:18px; margin-bottom:16px;}
  label{display:block; margin:6px 0 8px; color:var(--mut); font-size:14px;}
  input,button{padding:12px 12px; font-size:15px; border:1px solid var(--border); border-radius:12px; outline:none; background:#0b1220; color:var(--ink)}
  input::placeholder{color:#6b7280}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0b1220; font-weight:700; border:none}
  .btn-text{cursor:pointer; background:transparent; border:none; color:#a5b4fc; text-decoration:underline}
  .mut{color:var(--mut)}
  table{width:100%; border-collapse:collapse; border-radius:14px; overflow:hidden}
  th,td{padding:12px 14px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
  th{background:rgba(2,6,23,.5); color:#93c5fd; font-weight:600}
  tr.warning{background:rgba(245,158,11,.08)}
  tr.expired{background:rgba(239,68,68,.08)}
  .badge{padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block}
  .ok{color:#10b981; background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.4)}
  .warn{color:#f59e0b; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.4)}
  .exp{color:#ef4444; background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4)}
  .right{margin-left:auto}
  .hide{display:none}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>พอร์ทัลลูกค้า — ตรวจสถานะเอกสาร</div>
    <div class="right">
      <button id="logoutBtn" class="btn-text hide">ออกจากระบบ</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- บล็อกล็อกอิน -->
  <div id="loginCard" class="card">
    <h3 style="margin:0 0 10px;">เข้าสู่ระบบ</h3>
    <p class="mut" style="margin:0 0 12px;">ใส่อีเมลและรหัสผ่านที่ได้รับจากเจ้าหน้าที่</p>
    <form id="loginForm" class="row">
      <input id="email" type="email" placeholder="email@example.com" required style="min-width:260px"/>
      <input id="password" type="password" placeholder="รหัสผ่าน" required/>
      <button class="btn" type="submit">เข้าสู่ระบบ</button>
    </form>
    <p id="loginErr" class="mut" style="margin-top:8px; color:#fca5a5"></p>
  </div>

  <!-- บล็อกข้อมูลลูกค้า -->
  <div id="dataCard" class="card hide">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <div class="mut">บริษัทของคุณ</div>
        <div id="companyName" style="font-weight:700;font-size:16px">—</div>
      </div>
      <div class="right">
        <button id="refreshBtn" class="btn">รีเฟรช</button>
      </div>
    </div>

    <div style="margin-top:14px; overflow:auto">
      <table>
        <thead>
          <tr>
            <th>ลำดับ</th>
            <th>ชื่อการค้า</th>
            <th>ชื่อสามัญ/สูตร</th>
            <th>ทะเบียน</th>
            <th>ใบอนุญาต</th>
            <th>หมดอายุเดิม</th>
            <th>ต่อถึง</th>
            <th>สถานะ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="mut">กำลังโหลด…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/** ====== 1) ตั้งค่า Supabase ====== */
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA"; // anon key
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/** ====== 2) Helpers & UI ====== */
const $ = (id)=>document.getElementById(id);
function show(el){ el.classList.remove('hide'); }
function hide(el){ el.classList.add('hide'); }
function fmtDate(d){
  if(!d) return '-';
  const t = new Date(d);
  return isNaN(t) ? '-' : t.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
}
const WARNING_DAYS = 90;
function statusBadge(expiry, renewed){
  const base = expiry ? new Date(expiry) : null;
  const eff = renewed ? new Date(renewed) : base;
  if(!eff || isNaN(eff)) return `<span class="badge ok">ปกติ</span>`;
  const diff = Math.ceil((eff - new Date())/86400000);
  if(diff < 0) return `<span class="badge exp">หมดอายุ</span>`;
  if(diff <= WARNING_DAYS){
    const tail = renewed ? ` (ถึง ${fmtDate(eff)})` : '';
    return `<span class="badge warn">เหลือ ${diff} วัน${tail}</span>`;
  }
  return renewed ? `<span class="badge ok">ต่อแล้ว (ถึง ${fmtDate(eff)})</span>` : `<span class="badge ok">ปกติ</span>`;
}

/** ====== 3) Auth Flow ====== */
async function ensureSessionUI(){
  const { data: { user } } = await sb.auth.getUser();
  const loggedIn = !!user;
  if(loggedIn){
    hide($('loginCard'));
    show($('dataCard'));
    show($('logoutBtn'));
    loadMyCompanyAndDocs();
  }else{
    show($('loginCard'));
    hide($('dataCard'));
    hide($('logoutBtn'));
  }
}
$('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  $('loginErr').textContent = '';
  const email = $('email').value.trim();
  const password = $('password').value;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ $('loginErr').textContent = error.message || 'เข้าสู่ระบบไม่สำเร็จ'; return; }
  await ensureSessionUI();
});
$('logoutBtn').addEventListener('click', async ()=>{
  await sb.auth.signOut();
  await ensureSessionUI();
});
sb.auth.onAuthStateChange((_event, _session)=>{ ensureSessionUI(); });

/** ====== 4) Load data ของลูกค้า ====== */
async function loadMyCompanyAndDocs(){
  // 4.1 หาบริษัทของผู้ใช้จาก mapping (company_members)
  const { data: meMap, error: mapErr } = await sb
    .from('company_members')
    .select('company_code')
    .limit(1);
  if(mapErr){ $('companyName').textContent = 'โหลดบริษัทไม่สำเร็จ'; paintRows([]); return; }
  if(!meMap || meMap.length===0){ $('companyName').textContent = 'ยังไม่ได้ผูกบริษัท'; paintRows([]); return; }
  const code = meMap[0].company_code;

  // 4.2 ดึงชื่อบริษัท
  const { data: co, error: coErr } = await sb.from('companies').select('name').eq('code', code).single();
  $('companyName').textContent = co && co.name ? co.name : code;

  // 4.3 ดึงรายการเอกสาร
  const { data: docs, error: docErr } = await sb
    .from('product_registrations')
    .select('brand_name,common_label,registration_no,license_no,expiry_date,renewed_until')
    .eq('company_code', code)
    .order('expiry_date', { ascending: true });

  if(docErr){ $('tbody').innerHTML = `<tr><td colspan="8" class="mut">${docErr.message}</td></tr>`; return; }
  paintRows(docs || []);
}
$('refreshBtn').addEventListener('click', loadMyCompanyAndDocs);

function paintRows(rows){
  const tb = $('tbody');
  if(!rows || rows.length===0){
    tb.innerHTML = `<tr><td colspan="8" class="mut">ยังไม่มีข้อมูล</td></tr>`;
    return;
  }
  // จัดลำดับ: หมดอายุ → เตือน → ปกติ
  const scored = rows.map(r=>{
    const base = r.expiry_date ? new Date(r.expiry_date) : null;
    const eff = r.renewed_until ? new Date(r.renewed_until) : base;
    let order = 3, cls = '';
    if(eff){
      const diff = Math.ceil((eff - new Date())/86400000);
      if(diff < 0){ order = 1; cls = 'expired'; }
      else if(diff <= WARNING_DAYS){ order = 2; cls = 'warning'; }
    }
    return {...r, order, cls};
  }).sort((a,b)=> a.order - b.order || new Date(a.expiry_date||'9999-12-31') - new Date(b.expiry_date||'9999-12-31'));

  tb.innerHTML = '';
  scored.forEach((r,i)=>{
    tb.innerHTML += `<tr class="${r.cls}">
      <td>${i+1}</td>
      <td>${r.brand_name||'-'}</td>
      <td>${r.common_label||'-'}</td>
      <td>${r.registration_no||'-'}</td>
      <td>${r.license_no||'-'}</td>
      <td>${fmtDate(r.expiry_date)}</td>
      <td>${fmtDate(r.renewed_until)}</td>
      <td>${statusBadge(r.expiry_date, r.renewed_until)}</td>
    </tr>`;
  });
}

/** ====== 5) Start ====== */
document.addEventListener('DOMContentLoaded', ensureSessionUI);
</script>
</body>
</html>
