<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Customer Portal (รหัสลูกค้า)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0f172a; --card:rgba(30,41,59,.9); --mut:#94a3b8; --ink:#e2e8f0;
  --border:rgba(148,163,184,.25); --accent:#22d3ee; --accent2:#60a5fa;
  --radius:16px;
}

/* พื้นหลังและฟอนต์ */
body {
  margin:0;
  font-family:"Prompt", ui-sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 540px at 10% -10%, #0ea5a520 0%, transparent 60%),
    radial-gradient(800px 480px at 110% 0%, #38bdf820 0%, transparent 60%),
    var(--bg);
  font-size:18px;
  line-height:1.5;
}

/* การ์ด */
.wrap{max-width:1000px;margin:30px auto;padding:0 16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:0 8px 30px rgba(0,0,0,.3);
  margin-bottom:20px;
}

/* ปุ่มและ input */
input,button{
  font-size:17px;
  padding:12px 16px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#0b1220;
  color:var(--ink);
}
.btn{
  cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#0b1220;
  font-weight:700;
  border:none;
  transition:all .2s;
}
.btn:hover{opacity:.9}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

/* ตาราง */
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:17px}
th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
th{color:#93c5fd;font-size:18px}
.mut{color:var(--mut)}

/* ป้ายสถานะ */
.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
  font-weight:700;
  border:2px solid transparent;
  font-size:17px;
}
.badge-ok{color:#065f46;background:#ecfdf5;border-color:#34d399;}
.badge-warn{color:#92400e;background:#fffbeb;border-color:#fbbf24;}
.badge-exp{color:#7f1d1d;background:#fef2f2;border-color:#f87171;}
.badge-progress{color:#1e3a8a;background:#eff6ff;border-color:#60a5fa;}
.badge-pending{color:#7c2d12;background:#fff7ed;border-color:#f59e0b;}
.badge-stop{color:#991b1b;background:#fee2e2;border-color:#ef4444;}

/* ปุ่มหมายเหตุ */
.btn-note{
  background:#1e293b;
  color:#c7d2fe;
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  margin-top:6px;
}
.btn-note:hover{background:#334155;}

/* Popup หมายเหตุ */
#noteModal{
  position:fixed;inset:0;
  display:none;
  background:rgba(0,0,0,.6);
  align-items:center;justify-content:center;
  z-index:999;
}
#noteBox{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:0 8px 40px rgba(0,0,0,.4);
  max-width:450px;width:90%;
  font-size:18px;
}
#noteBox h3{margin:0 0 10px;color:#93c5fd;font-size:22px}
#noteBox p{margin:8px 0}
#closeNote{
  margin-top:16px;padding:10px 20px;border:none;border-radius:10px;
  background:var(--accent);color:#0b1220;cursor:pointer;font-weight:700;font-size:17px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0 0 10px">เข้าสู่พอร์ทัลลูกค้า</h2>
    <p class="mut" style="margin:0 0 12px">กรอกรหัสที่ได้รับจากเจ้าหน้าที่ (ไม่ต้องใช้อีเมล)</p>
    <div class="row">
      <input id="code" placeholder="ใส่รหัสลูกค้า เช่น RG-1234" style="min-width:260px" autocomplete="one-time-code" inputmode="text">
      <button class="btn" id="enterBtn">เข้าดูข้อมูล</button>
    </div>
    <div id="err" class="mut" style="color:#fca5a5;margin-top:8px"></div>
  </div>

  <div class="card" id="dataCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="mut">บริษัทของคุณ</div>
        <div id="companyName" style="font-weight:700;font-size:20px">—</div>
      </div>
      <div class="spacer"></div>
      <input id="q" placeholder="พิมพ์ค้นหา ชื่อการค้า / ชื่อสามัญ ..." style="min-width:240px">
      <button id="clearBtn" class="btn" style="background:#0b1220;color:#cbd5e1;border:1px solid var(--border)">ล้าง</button>
      <button class="btn" id="refreshBtn">รีเฟรช</button>
    </div>

    <div class="mut" id="count" style="margin-top:8px">—</div>

    <table>
      <thead>
        <tr>
          <th>บริษัท</th>
          <th>ชื่อการค้า</th>
          <th>ชื่อสามัญ/สูตร</th>
          <th>ทะเบียน</th>
          <th>ใบอนุญาต</th>
          <th>หมดอายุเดิม (พ.ศ.)</th>
          <th>สถานะ / หมายเหตุ</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="7" class="mut">—</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Popup -->
<div id="noteModal">
  <div id="noteBox">
    <h3>รายละเอียดหมายเหตุ</h3>
    <p id="noteBrand">ชื่อการค้า: —</p>
    <p id="noteStatus">สถานะ: —</p>
    <p id="noteText">หมายเหตุ: —</p>
    <button id="closeNote">ปิด</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const $ = id => document.getElementById(id);
const WARNING_DAYS = 90;

/* ---- Utilities ---- */
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function fmtDateBE(d){
  if(!d) return '-'; const t=new Date(d); if(isNaN(t)) return '-';
  try{return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'long',day:'numeric',timeZone:'Asia/Bangkok'});}
  catch(e){const m=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];return `${t.getDate()} ${m[t.getMonth()]} ${t.getFullYear()+543}`;}
}

/* ---- สถานะหลายสี ---- */
function statusText(row){
  const rawStatus =
    (row?.renewed_status && String(row.renewed_status).trim()) ||
    (row?.status_text && String(row.status_text).trim()) || '';

  const s = rawStatus.toLowerCase();
  let label = rawStatus, cls = '';

  if(s.includes('ไม่ต่อ')||s.includes('ยกเลิก')) cls='badge-stop';
  else if(s.includes('กำลัง')||s.includes('ดำเนิน')) cls='badge-progress';
  else if(s.includes('รอ')||s.includes('ลงนาม')) cls='badge-pending';
  else if(s.includes('หมด')) cls='badge-exp';
  else if(s.includes('เหลือ')) cls='badge-warn';
  else if(s.includes('แล้ว')||s==='ok'||s==='done') cls='badge-ok';

  if(cls) return `<span class="badge ${cls}">${escapeHtml(label)}</span>`;
  if(row?.renewed_until) return `<span class="badge badge-ok">ดำเนินการแล้ว</span>`;

  const eff = row?.expiry_date?new Date(row.expiry_date):null;
  if(!eff||isNaN(eff)) return `<span class="badge badge-ok">ปกติ</span>`;
  const diff = Math.ceil((eff - new Date())/86400000);
  if(diff < 0) return `<span class="badge badge-exp">หมดอายุ</span>`;
  if(diff <= WARNING_DAYS) return `<span class="badge badge-warn">เหลือ ${diff} วัน</span>`;
  return `<span class="badge badge-ok">ปกติ</span>`;
}

/* ---- ตาราง ---- */
let CURRENT_CODE='', FULL_ROWS=[], FILTERED=[];
function bindNoteButtons(rows){
  document.querySelectorAll('.btn-note').forEach((btn,idx)=>btn.addEventListener('click',()=>showNote(rows[idx])));
}
function render(q=''){
  const tb=$('tbody'); const rows=FILTERED;
  if(rows.length===0){
    tb.innerHTML=`<tr><td colspan="7" class="mut">ไม่พบรายการที่ตรงกับ “${escapeHtml(q)}”</td></tr>`;
  }else{
    tb.innerHTML=rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.company_name||'-')}</td>
        <td>${escapeHtml(r.brand_name||'-')}</td>
        <td>${escapeHtml(r.common_label||'-')}</td>
        <td>${escapeHtml(r.registration_no||'-')}</td>
        <td>${escapeHtml(r.license_no||'-')}</td>
        <td>${fmtDateBE(r.expiry_date)}</td>
        <td>
          ${statusText(r)}
          ${(r.renewed_status||r.renewed_note)?`<br><button class="btn-note">ดูหมายเหตุ</button>`:''}
        </td>
      </tr>`).join('');
    bindNoteButtons(rows);
  }
  $('count').textContent=`แสดง ${rows.length.toLocaleString('th-TH')} รายการ (ทั้งหมด ${FULL_ROWS.length.toLocaleString('th-TH')})`;
}

function applyFilter(){
  const raw=$('q').value.trim().toLowerCase();
  if(!raw){FILTERED=[...FULL_ROWS];}
  else{
    FILTERED=FULL_ROWS.filter(r=>
      (r.brand_name||'').toLowerCase().includes(raw)||
      (r.common_label||'').toLowerCase().includes(raw)
    );
  }
  render(raw);
}

/* ---- โหลดข้อมูลจากรหัสลูกค้า ---- */
async function loadCompanyByCode(){
  if(!CURRENT_CODE) return;
  const code=CURRENT_CODE.trim().toUpperCase();

  const nameRes=await sb.rpc('get_company_name_by_code',{p_plain_code:code});
  if(nameRes.error||!nameRes.data){
    $('err').textContent=nameRes.error?.message||'รหัสไม่ถูกต้องหรือถูกปิดใช้งาน';
    $('dataCard').style.display='none';return;
  }
  $('companyName').textContent=nameRes.data;
  const res=await sb.rpc('get_company_portal',{p_plain_code:code});
  if(res.error){$('err').textContent=res.error.message;$('dataCard').style.display='none';return;}

  FULL_ROWS=res.data||[]; $('err').textContent=''; $('dataCard').style.display='block';
  $('q').value=''; applyFilter();
}

/* ---- Popup ---- */
function showNote(row){
  $('noteBrand').textContent=`ชื่อการค้า: ${row?.brand_name||'-'}`;
  $('noteStatus').textContent=`สถานะ: ${row?.renewed_status||row?.status_text||'-'}`;
  $('noteText').textContent=`หมายเหตุ: ${row?.renewed_note||'-'}`;
  $('noteModal').style.display='flex';
}

/* ---- เริ่มทำงาน ---- */
document.addEventListener('DOMContentLoaded',()=>{
  $('enterBtn').addEventListener('click',async()=>{
    const code=$('code').value.trim().toUpperCase();
    if(!code){$('err').textContent='กรุณาใส่รหัสลูกค้า';return;}
    $('err').textContent=''; CURRENT_CODE=code; await loadCompanyByCode();
  });
  $('code').addEventListener('keydown',e=>{if(e.key==='Enter')$('enterBtn').click();});
  $('refreshBtn').addEventListener('click',loadCompanyByCode);
  $('q').addEventListener('input',applyFilter);
  $('clearBtn').addEventListener('click',()=>{$('q').value='';applyFilter();});
  $('closeNote').addEventListener('click',()=>$('noteModal').style.display='none');
  $('noteModal').addEventListener('click',e=>{if(e.target.id==='noteModal')$('noteModal').style.display='none';});
});
</script>
</body>
</html>
