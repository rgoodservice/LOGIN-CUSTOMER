<!DOCTYPE html><html lang="th"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="config.js"></script>
<style>
:root{--bg:#f6fbff;--ink:#0f172a;--muted:#64748b;--card:#fff;--bd:#e6eef5;--a:#0ea5a5;--a2:#60a5fa;--warn:#b45309;--warnbg:#fff7ed;--exp:#b91c1c;--expbg:#fff1f2;--ok:#0f766e;--okbg:#ecfdf5}
*{box-sizing:border-box} body{margin:0;font-family:"Prompt",ui-sans-serif;background:radial-gradient(1200px 600px at 10% -10%,#e6f7ff 0%,transparent 60%),radial-gradient(900px 500px at 110% 0%,#e8fff6 0%,transparent 60%),#f6fbff;color:var(--ink)}
header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--bd)}
.bar{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--a),var(--a2))}
.flex-1{flex:1}.btn{padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#f8fafc;cursor:pointer}
.container{max-width:1100px;margin:20px auto;padding:0 16px 28px}
.card{background:var(--card);border:1px solid var(--bd);border-radius:14px;box-shadow:0 4px 18px rgba(10,30,60,.06);padding:18px;margin-bottom:16px}
label{display:block;margin:6px 0 8px;color:var(--muted);font-size:14px}
input,select,button{padding:11px 12px;border:1px solid var(--bd);border-radius:10px;font-size:15px}
.btnp{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;font-weight:600}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
th,td{padding:12px 14px;border-bottom:1px solid var(--bd);text-align:left}
th{background:#f1f8ff}
tr.warning{background:var(--warnbg)} tr.expired{background:var(--expbg)}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block}
.badge.ok{color:var(--ok);background:var(--okbg)} .badge.warning{color:var(--warn);background:var(--warnbg)} .badge.expired{color:var(--exp);background:var(--expbg)}
.muted{color:var(--muted)}
</style></head>
<body>
<header><div class="bar">
  <div class="logo"></div><div class="flex-1"><strong>Admin Portal</strong></div>
  <div id="who" class="muted"></div>
  <button id="btnOut" class="btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div></header>

<div class="container">
  <div class="card">
    <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</strong></label>
    <select id="companySelect"><option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚Äî</option></select>
    <div class="muted" style="margin-top:6px">* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (admin/staff)</div>
  </div>

  <div class="card">
    <label><strong>üì§ ‡πÇ‡∏´‡∏•‡∏î Excel</strong></label>
    <div><input type="file" id="excel" accept=".xlsx,.xls"> <button class="btnp" id="btnImport">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button></div>
    <div class="muted" style="margin-top:6px">‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: brand_name, common_label, registration_no, license_no, expiry_date</div>
  </div>

  <div class="card">
    <label><strong>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></label>
    <form id="addForm" style="display:flex;gap:10px;flex-wrap:wrap">
      <input id="brand_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤" required>
      <input id="common_label" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£" required style="min-width:240px">
      <input id="registration_no" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="license_no" placeholder="‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï">
      <input id="expiry_date" type="date" required>
      <button class="btnp">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </form>
  </div>

  <div class="card">
    <table>
      <thead><tr>
        <th>#</th><th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th><th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</th><th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr></thead>
      <tbody id="tbody"><tr><td colspan="9" class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const {SUPABASE_URL,SUPABASE_ANON_KEY,WARNING_DAYS}=window.APP_CONFIG;
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const $=id=>document.getElementById(id); let currentCompany='';

function classify(exp){ if(!exp) return {cls:'',badge:'<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>',order:3};
  const d=new Date(exp), now=new Date(); const diff=Math.ceil((d-now)/86400000);
  if(isNaN(d)) return {cls:'',badge:'<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>',order:3};
  if(diff<0) return {cls:'expired',badge:'<span class="badge expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>',order:1};
  if(diff<=WARNING_DAYS) return {cls:'warning',badge:`<span class="badge warning">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`,order:2};
  return {cls:'',badge:'<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>',order:3};
}
function fmtDate(d){ if(!d) return '-'; const t=new Date(d); return isNaN(t)?'-':t.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'})}
function excelSerialToISO(s){ if(!isFinite(s)) return null; const base=new Date(Date.UTC(1899,11,30)); const dt=new Date(base.getTime()+s*86400000); return dt.toISOString().split('T')[0]; }
function normalizeExpiry(v){ if(v==null||v==='') return null; if(typeof v==='number') return excelSerialToISO(v); const d=new Date(v); return isNaN(d)?null:d.toISOString().split('T')[0]; }

async function initApp(user){ $('who').textContent=user.email||user.id; await loadMyCompanies(); }
function showLoading(){ $('tbody').innerHTML='<tr><td colspan="9" class="muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Ä¶</td></tr>'; }

document.addEventListener('DOMContentLoaded', async ()=>{
  showLoading();
  let {data:{session}}=await sb.auth.getSession();
  if(session) initApp(session.user);
  sb.auth.onAuthStateChange((_e, newSession)=>{ if(newSession) initApp(newSession.user); else location.href='admin_login.html'; });
});
$('btnOut').onclick=async()=>{ await sb.auth.signOut(); location.href='admin_login.html'; };

async function loadMyCompanies(){
  const user=(await sb.auth.getUser()).data.user;
  const sel=$('companySelect');
  const {data:members,error}=await sb.from('company_members').select('company_code,role').eq('user_id',user.id).in('role',['admin','staff']);
  if(error){ sel.innerHTML='<option value="">(‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</option>'; return; }
  const codes=(members||[]).map(m=>m.company_code); if(!codes.length){ sel.innerHTML='<option value="">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</option>'; return; }
  const {data:companies}=await sb.from('companies').select('code,name').in('code',codes);
  const map=new Map((companies||[]).map(c=>[c.code,c.name])); sel.innerHTML='<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>';
  codes.forEach(c=> sel.innerHTML+=`<option value="${c}">${map.get(c)||c} (${c})</option>`);
}
$('companySelect').onchange=e=> e.target.value && loadDocs(e.target.value);

async function loadDocs(code){
  currentCompany=code;
  const tb=$('tbody'); tb.innerHTML='<tr><td colspan="9" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>';
  const {data,error}=await sb.from('product_registrations').select('*').eq('company_code',code);
  if(error){ tb.innerHTML=`<tr><td colspan="9">‚ùå ${error.message}</td></tr>`; return; }
  const rows=(data||[]).map(r=>({...r,...classify(r.expiry_date)})).sort((a,b)=> a.order-b.order || new Date(a.expiry_date)-new Date(b.expiry_date));
  tb.innerHTML=rows.length?'':`<tr><td colspan="9" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
  rows.forEach((r,i)=> tb.innerHTML+=`<tr class="${r.cls}">
    <td>${i+1}</td><td>${r.company_code||'-'}</td><td>${r.brand_name||'-'}</td><td>${r.common_label||'-'}</td>
    <td>${r.registration_no||'-'}</td><td>${r.license_no||'-'}</td><td>${fmtDate(r.expiry_date)}</td><td>${r.badge}</td>
    <td><button class="btn" style="background:#fee2e2;border-color:#fecaca" onclick="delRow('${r.id}')">‡∏•‡∏ö</button></td></tr>`);
}
window.delRow=async id=>{ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; const {error}=await sb.from('product_registrations').delete().eq('id',id); if(error) alert(error.message); else loadDocs(currentCompany); };

document.getElementById('addForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload={ company_code:currentCompany, brand_name:$('#brand_name').value.trim(), common_label:$('#common_label').value.trim(),
    registration_no:$('#registration_no').value.trim(), license_no:$('#license_no').value.trim(), expiry_date:$('#expiry_date').value||null };
  if(!payload.brand_name||!payload.common_label) return alert('‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const {error}=await sb.from('product_registrations').insert(payload); if(error) return alert(error.message);
  e.target.reset(); loadDocs(currentCompany);
});

document.getElementById('btnImport').onclick=()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
  const f=document.getElementById('excel').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
  const r=new FileReader(); r.onload=async(ev)=>{
    try{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'}), ws=wb.Sheets[wb.SheetNames[0]];
      let rows=XLSX.utils.sheet_to_json(ws,{defval:''}).map(o=>{
        const k=Object.fromEntries(Object.entries(o).map(([kk,v])=>[String(kk).trim().toLowerCase(),v]));
        return { company_code:currentCompany,
          brand_name:k.brand_name||k['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤']||'',
          common_label:k.common_label||k['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç']||k['‡∏™‡∏π‡∏ï‡∏£']||k['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£']||'',
          registration_no:k.registration_no||k['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô']||'',
          license_no:k.license_no||k['‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï']||'',
          expiry_date:normalizeExpiry(k.expiry_date ?? k['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'] ?? '')
        };
      }).filter(r=>r.brand_name||r.common_label);
      if(!rows.length) return alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ');
      const {error}=await sb.from('product_registrations').insert(rows);
      if(error) return alert('‚ùå '+error.message); alert('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ '+rows.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); $('#excel').value=''; loadDocs(currentCompany);
    }catch(e){ alert('‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
  }; r.readAsArrayBuffer(f);
};
</script></body></html>
