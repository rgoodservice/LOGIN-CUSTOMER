<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.Good Service ‚Äî Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      margin: 0;
      padding: 20px;
    }
    h1, h2, h3 { margin: 0 0 10px; }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
      text-align: left;
    }
    th {
      background: rgba(59,130,246,0.1);
      color: #60a5fa;
    }
    tr:hover td { background: rgba(59,130,246,0.05); }
    .progress-bar {
      height: 12px;
      background: rgba(148,163,184,0.2);
      border-radius: 50px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      width: 0%;
      transition: width 0.6s ease;
    }
    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      color: white;
      background: linear-gradient(135deg,#3b82f6,#8b5cf6);
    }
  </style>
</head>
<body>
  <h1>üìä Dashboard ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
  <section class="card">
    <h3>‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
    <div id="myCasesEmpty" style="color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‚Ä¶</div>
    <div class="table-container" id="myCasesTableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
            <th>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
            <th>‡πÇ‡∏ô‡πâ‡∏ï</th>
          </tr>
        </thead>
        <tbody id="myCasesTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
  <section class="card">
    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™</h3>
    <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏™: <span id="caseNo">-</span></p>
    <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="caseStatus">-</span></p>
    <p>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤: <span id="tradeName">-</span></p>
    <p>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç: <span id="commonName">-</span></p>
    <p>‡πÇ‡∏ô‡πâ‡∏ï: <span id="notes">-</span></p>

    <div style="margin-top:10px;">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <p style="margin-top:5px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: <span id="progressPct">0%</span></p>
    </div>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./supabase-config.js";

    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $id = (s)=>document.querySelector(s);

    // ===== My Cases List =====
    async function renderMyCasesList(userId){
      const tbody = document.getElementById("myCasesTbody");
      const empty = document.getElementById("myCasesEmpty");
      const wrap  = document.getElementById("myCasesTableWrap");

      tbody.innerHTML = "<tr><td colspan='7'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

      const { data, error } = await supa
        .from("cases")
        .select("id, case_number, trade_name, common_name, status, progress, due_date, notes")
        .eq("user_id", userId)
        .order("created_at", { ascending: false });

      if(error){
        console.error(error);
        tbody.innerHTML = "<tr><td colspan='7'>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>";
        return;
      }

      if(!data || data.length === 0){
        tbody.innerHTML = "<tr><td colspan='7'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™</td></tr>";
        wrap.style.display = "none";
        return;
      }

      empty.style.display = "none";
      wrap.style.display = "block";

      tbody.innerHTML = data.map(c => {
        const due = c.due_date ? new Date(c.due_date).toLocaleDateString('th-TH') : '-';
        const pct = (c.progress ?? 0) + '%';
        return `
          <tr>
            <td>${c.case_number}</td>
            <td>${c.trade_name || '-'}</td>
            <td>${c.common_name || '-'}</td>
            <td>${c.status || '-'}</td>
            <td>${pct}</td>
            <td>${due}</td>
            <td>${c.notes || '-'}</td>
          </tr>
        `;
      }).join("");

      // real-time
      supa.channel('rt:mycases')
        .on('postgres_changes', { event:'*', schema:'public', table:'cases', filter:`user_id=eq.${userId}` }, () => {
          renderMyCasesList(userId);
        })
        .subscribe();
    }

    // ===== Dashboard ‡∏£‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß =====
    async function mountDashboard(caseCode){
      const { data: cs, error } = await supa
        .from('cases')
        .select('*')
        .eq('case_number', caseCode)
        .maybeSingle();

      if (error) { console.error(error); return; }
      if (!cs) { console.warn('Case not found'); return; }

      $id('#caseNo').textContent     = cs.case_number;
      $id('#caseStatus').textContent = cs.status || '-';
      $id('#tradeName').textContent  = cs.trade_name || '-';
      $id('#commonName').textContent = cs.common_name || '-';
      $id('#notes').textContent      = cs.notes || '-';

      renderProgress(cs.progress ?? 0);

      function renderProgress(pct){
        const p = Math.max(0, Math.min(100, Number(pct) || 0));
        $id('#progressFill').style.width = p + '%';
        $id('#progressPct').textContent  = p + '%';
      }

      supa.channel('rt:cases')
        .on('postgres_changes', { event:'*', schema:'public', table:'cases', filter:`id=eq.${cs.id}` }, (p)=>{
          const row = p.new || p.old;
          $id('#caseStatus').textContent = row.status || '-';
          $id('#notes').textContent      = row.notes || '-';
          renderProgress(row.progress ?? 0);
        })
        .subscribe();
    }

    // ===== Main =====
    const { data: { user } } = await supa.auth.getUser();
    if (!user) { location.href = "index.html"; }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
    renderMyCasesList(user.id);

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ query string ?case=... ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    const params   = new URLSearchParams(location.search);
    const caseCode = params.get('case');
    if (caseCode) {
      mountDashboard(caseCode);
    }
  </script>
</body>
</html>
