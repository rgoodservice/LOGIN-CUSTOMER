<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏° ‚Äî Admin Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family:'Prompt',sans-serif; background:#f8fafc; margin:0; color:#0f172a; }
  header { background:#0ea5a5; color:white; padding:14px 20px; font-weight:600; }
  .container{ max-width:1100px; margin:20px auto; padding:0 16px; }
  h2{ margin-top:32px; border-left:6px solid #0ea5a5; padding-left:10px; color:#0f172a; display:flex;align-items:center;justify-content:space-between;}
  table{ width:100%; border-collapse:collapse; margin-top:8px; background:white; border-radius:10px; overflow:hidden; box-shadow:0 3px 12px rgba(0,0,0,0.05);}
  th,td{ padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:15px;}
  th{ background:#f1f5f9; position:sticky; top:0; }
  tr:nth-child(even){ background:#f9fafb; }
  .status-badge{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:13px; font-weight:600;}
  .expired{ background:#fee2e2; color:#b91c1c;}
  .warning{ background:#fef9c3; color:#92400e;}
  .ok{ background:#dcfce7; color:#166534;}
  .note{ color:#64748b; font-size:13px;}
  input[type=search]{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;width:100%;max-width:300px;margin-bottom:10px;}
  button{cursor:pointer;border:none;padding:6px 10px;border-radius:8px;background:#0ea5a5;color:white;font-size:13px;}
  button:hover{background:#0d9488;}
</style>
</head>
<body>
<header>üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°</header>
<div class="container">
  <div id="companyName" style="font-weight:600;color:#334155;margin-bottom:10px;"></div>
  <div id="sections"></div>
</div>

<script>
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function fmtDateBE(d){
  if(!d)return'-';
  const t=new Date(d);
  if(isNaN(t))return'-';
  return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'short',day:'numeric'});
}
function classify(r){
  if(r.note_status==='‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ï‡πà‡∏≠') return 'not_renewed';
  if(r.renewed_until) return 'done';
  const diff=Math.ceil((new Date(r.expiry_date)-new Date())/86400000);
  if(diff<0)return 'expired';
  if(diff<=90)return 'warning';
  return 'ok';
}

let cats={expired:[],warning:[],done:[],not_renewed:[]};
const mapLabel={
  expired:'‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß',
  warning:'‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 90 ‡∏ß‡∏±‡∏ô',
  done:'‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß',
  not_renewed:'üö´ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ï‡πà‡∏≠ / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
};

async function load(){
  const params=new URLSearchParams(location.search);
  const code=params.get('code');
  if(!code){ document.body.innerHTML='‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'; return;}
  document.getElementById('companyName').textContent=`‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${code}`;
  const {data,error}=await sb.from('product_registrations').select('*').eq('company_code',code);
  if(error){document.body.innerHTML='‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';return;}
  cats={expired:[],warning:[],done:[],not_renewed:[]};
  (data||[]).forEach(r=>cats[classify(r)].push(r));
  renderSections();
}

function renderSections(){
  const sections=document.getElementById('sections');
  sections.innerHTML='';
  for(const key of Object.keys(mapLabel)){
    const list=cats[key];
    const html=list.length?`
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <input type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ..." oninput="filterTable('${key}',this.value)">
        <button onclick="exportExcel('${key}')">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
      </div>
      <table id="tbl_${key}">
        <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th><th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead>
        <tbody>${list.map(r=>`
          <tr>
            <td>${r.brand_name||''}</td>
            <td>${r.common_label||''}</td>
            <td>${fmtDateBE(r.expiry_date)}</td>
            <td class="note">${r.note_text||''}</td>
          </tr>`).join('')}
        </tbody>
      </table>`:`<div class="note">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
    sections.innerHTML+=`<h2>${mapLabel[key]} (${list.length})</h2>${html}`;
  }
}

function filterTable(key,term){
  const tb=document.querySelector(`#tbl_${key} tbody`);
  if(!tb)return;
  term=term.toLowerCase();
  for(const tr of tb.rows){
    tr.style.display=tr.textContent.toLowerCase().includes(term)?'':'none';
  }
}

// === Export Excel ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î ===
function exportExcel(key){
  const rows=cats[key];
  if(!rows?.length)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ');
  const aoa=[['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£','‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏û.‡∏®.)','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
  rows.forEach(r=>{
    aoa.push([r.brand_name||'',r.common_label||'',fmtDateBE(r.expiry_date),r.note_text||'']);
  });
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,mapLabel[key].replace(/[^‡∏Å-‡πôa-zA-Z0-9]/g,'').slice(0,31));
  XLSX.writeFile(wb,`${mapLabel[key].replace(/[^‡∏Å-‡πôa-zA-Z0-9]/g,'_')}.xlsx`);
}

load();
</script>
</body>
</html>
