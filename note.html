<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin ‚Äî ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>

<!-- Supabase & SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f6fbff; --ink:#0f172a; --muted:#64748b; --border:#e6eef5;
  --accent:#0ea5a5; --accent-2:#60a5fa;
  --ok:#0f766e; --ok-bg:#ecfdf5;
  --warn:#b45309; --warn-bg:#fff7ed;
}
body { margin:0; font-family:"Prompt",ui-sans-serif,system-ui; color:var(--ink); background:var(--bg); }
header { padding:16px 20px; background:linear-gradient(180deg,#e8fff6,#f0fbff); font-weight:600; font-size:20px; border-bottom:1px solid var(--border); }
.container { max-width:1100px; margin:20px auto; padding:0 16px; }
select, button, input { padding:9px 12px; border-radius:8px; font-size:15px; border:1px solid var(--border); background:#fff; }
button.btn-primary { background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:white; border:none; }
.controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
.controls .line2 { display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%; }
#search { min-width:260px; }
#msg { font-size:14px; color:#0f766e; }
#count { color:var(--muted); font-size:14px; }
.summary { display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px; }
.badge { padding:3px 8px; border-radius:999px; background:#eef2ff; color:#334155; border:1px solid #e5e7eb; }
.badge.ok { background:var(--ok-bg); color:var(--ok); border-color:#a7f3d0; }
.badge.warn { background:var(--warn-bg); color:var(--warn); border-color:#fde68a; }
table { width:100%; border-collapse:collapse; background:white; border-radius:10px; margin-top:10px; overflow:hidden; }
th, td { padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
th { background:#f7fbff; position:sticky; top:0; }
td.editable { cursor:text; }
td.editing { background:#fffbe6; }
.badge-ok { background:var(--ok-bg); color:var(--ok); padding:4px 8px; border-radius:6px; font-size:12px; }
.badge-warn { background:var(--warn-bg); color:var(--warn); padding:4px 8px; border-radius:6px; font-size:12px; }
mark { background:#fde68a80; padding:0 2px; border-radius:3px; }
.toggle { display:flex; gap:6px; align-items:center; }
</style>
</head>
<body>
<header>üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß & ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠)</header>

<div class="container">
  <div class="controls">
    <div class="line1" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;">
      <select id="companySelect"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option></select>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">
      <select id="statusFilter" title="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">
        <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="done">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
        <option value="pending">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
      </select>
      <label class="toggle">
        <input type="checkbox" id="onlyNote"> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
      </label>
      <button id="clearBtn">‡∏•‡πâ‡∏≤‡∏á</button>
      <button id="refreshBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
      <button id="exportBtn" class="btn-primary">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
      <div class="spacer" style="flex:1"></div>
      <div id="count"></div>
    </div>
    <div class="line2">
      <div class="summary">
        <span>‡∏™‡∏£‡∏∏‡∏õ:</span>
        <span id="sumAll" class="badge">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0</span>
        <span id="sumDone" class="badge ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß 0</span>
        <span id="sumPending" class="badge warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ 0</span>
      </div>
      <div id="msg" style="margin-left:auto"></div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
        <th>‡∏ï‡πà‡∏≠‡∏ñ‡∏∂‡∏á (‡∏û.‡∏®.)</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="6" style="color:var(--muted)">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>
    </tbody>
  </table>
</div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
let allRows = [];     // ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å DB
let filtered = [];    // ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á
let currentCompany = '';

/* ===== Utils ===== */
function fmtDateBE(d){
  if(!d) return '‚Äî';
  const t = new Date(d);
  if(isNaN(t)) return '‚Äî';
  try{
    return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'short',day:'numeric'});
  }catch{ return `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()+543}`; }
}
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function highlight(text, q){
  const s = String(text ?? '');
  if(!q) return escapeHtml(s);
  const re = new RegExp(escapeRegExp(q), 'gi');
  return escapeHtml(s).replace(re, m=>`<mark>${m}</mark>`);
}
function applyCount(){
  $('count').textContent = `‡πÅ‡∏™‡∏î‡∏á ${filtered.length.toLocaleString('th-TH')} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allRows.length.toLocaleString('th-TH')})`;
  const done = allRows.filter(r=> !!r.renewed_until).length;
  const pending = allRows.length - done;
  $('sumAll').textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allRows.length.toLocaleString('th-TH')}`;
  $('sumDone').textContent = `‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ${done.toLocaleString('th-TH')}`;
  $('sumPending').textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ${pending.toLocaleString('th-TH')}`;
}

/* ===== Load companies ===== */
async function loadCompanies(){
  const {data,error}=await sb.from('companies').select('code').order('code');
  if(error){ alert(error.message); return; }
  $('companySelect').innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>' + (data||[]).map(c=>`<option>${c.code}</option>`).join('');
}

/* ===== Fetch rows ===== */
async function loadRows(){
  const code = $('companySelect').value;
  currentCompany = code;
  if(!code){
    allRows = []; filtered = [];
    $('tbody').innerHTML = '<tr><td colspan="6" style="color:#64748b">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>';
    applyCount();
    return;
  }
  const {data,error}=await sb.from('product_registrations')
    .select('id,brand_name,common_label,renewed_until,note')
    .eq('company_code',code)
    .order('renewed_until',{ascending:true,nullsFirst:false});
  if(error){ alert(error.message); return; }
  allRows = data||[];
  applyFilter(); // ‡∏à‡∏∞ render + count ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
}

/* ===== Filter (search + status + onlyNote) ===== */
function applyFilter(){
  const q = $('search').value.trim().toLowerCase();
  const status = $('statusFilter').value;     // all | done | pending
  const onlyNote = $('onlyNote').checked;     // true | false

  filtered = allRows.filter(r=>{
    // text search
    const passSearch = !q ||
      (r.brand_name||'').toLowerCase().includes(q) ||
      (r.common_label||'').toLowerCase().includes(q) ||
      (r.note||'').toLowerCase().includes(q);

    // status filter
    const isDone = !!r.renewed_until;
    const passStatus = (status==='all') || (status==='done' && isDone) || (status==='pending' && !isDone);

    // only with note
    const passNote = !onlyNote || !!(r.note && r.note.trim());

    return passSearch && passStatus && passNote;
  });

  render(q);
}

/* ===== Render ===== */
function render(q=''){
  const tb = $('tbody');
  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="6" style="color:#64748b">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
    applyCount();
    return;
  }
  tb.innerHTML = filtered.map((r,i)=>{
    const status = r.renewed_until ? `<span class="badge-ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>` : `<span class="badge-warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
    return `
      <tr>
        <td>${i+1}</td>
        <td>${highlight(r.brand_name||'', q)}</td>
        <td>${highlight(r.common_label||'', q)}</td>
        <td>${r.renewed_until ? fmtDateBE(r.renewed_until) : '‚Äî'}</td>
        <td class="editable" data-id="${r.id}">${r.note ? highlight(r.note, q) : '<span style="color:#999">‚Äî</span>'}</td>
        <td>${status}</td>
      </tr>
    `;
  }).join('');
  applyCount();
}

/* ===== Inline edit: note ===== */
$('tbody').addEventListener('dblclick', async e=>{
  const td=e.target.closest('.editable'); if(!td) return;
  if(td.classList.contains('editing')) return;
  const id=td.dataset.id;
  const plain = td.textContent === '‚Äî' ? '' : td.textContent;
  td.classList.add('editing');
  const input=document.createElement('input');
  input.type='text'; input.value=plain; input.style.width='100%';
  td.innerHTML=''; td.appendChild(input); input.focus(); input.select();

  const finish = async(commit)=>{
    const val=input.value.trim();
    td.classList.remove('editing');
    if(!commit){ td.textContent = plain || '‚Äî'; return; }
    const {error}=await sb.from('product_registrations').update({note:val||null}).eq('id',id);
    if(error){ alert(error.message); td.textContent=plain||'‚Äî'; return; }
    // sync caches
    const ix = allRows.findIndex(x=>x.id===id);
    if(ix>-1){ allRows[ix].note = val || null; }
    applyFilter(); // re-render + count
    $('msg').textContent='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‚úì';
    setTimeout(()=>{$('msg').textContent='';},1800);
  };
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter') finish(true);
    if(e.key==='Escape') finish(false);
  });
  input.addEventListener('blur',()=>finish(true));
});

/* ===== Export Excel (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ===== */
$('exportBtn').onclick=()=>{
  if(!filtered.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  const aoa=[['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£','‡∏ï‡πà‡∏≠‡∏ñ‡∏∂‡∏á (‡∏û.‡∏®.)','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
  filtered.forEach(r=>{
    aoa.push([
      currentCompany,
      r.brand_name||'',
      r.common_label||'',
      r.renewed_until ? fmtDateBE(r.renewed_until) : '‚Äî',
      r.note||'',
      r.renewed_until ? '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'
    ]);
  });
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,(currentCompany||'All').slice(0,31));
  XLSX.writeFile(wb,`‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${currentCompany||'ALL'}.xlsx`);
};

/* ===== Events ===== */
$('companySelect').addEventListener('change', loadRows);
$('refreshBtn').addEventListener('click', loadRows);
$('search').addEventListener('input', applyFilter);
$('statusFilter').addEventListener('change', applyFilter);
$('onlyNote').addEventListener('change', applyFilter);
$('clearBtn').addEventListener('click', ()=>{
  $('search').value='';
  $('statusFilter').value='all';
  $('onlyNote').checked=false;
  applyFilter();
});

/* ===== Start ===== */
loadCompanies();
</script>
</body>
</html>
