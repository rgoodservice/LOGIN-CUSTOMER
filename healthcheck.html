<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Supabase Health Check</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--ink:#0f172a;--muted:#64748b;--ok:#065f46;--err:#991b1b;--bg:#f6fbff;--card:#fff;--bd:#e6eef5}
  *{box-sizing:border-box} body{margin:0;font-family:"Prompt",system-ui;background:var(--bg);color:var(--ink)}
  .wrap{max-width:900px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 3px 18px rgba(10,30,60,.05)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button,select{padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:14px}
  button{background:linear-gradient(135deg,#0ea5e9,#10b981);color:#fff;border:none;font-weight:600;cursor:pointer}
  code{background:#f1f5f9;border-radius:8px;padding:2px 6px}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse} th,td{padding:10px 12px;border-bottom:1px solid var(--bd);text-align:left}
  th{background:#f1f8ff}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>ü©∫ Supabase Health Check</h2>
    <div class="muted">‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô VS Code ‚Üí Open with Live Server)</div>
    <div style="margin-top:8px">Origin: <code id="origin"></code></div>
    <div>Redirect sample (admin.html): <code id="redir"></code></div>
  </div>

  <div class="card">
    <h3>1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
    <div class="row">
      <input id="url" style="min-width:320px" />
      <input id="key" style="min-width:480px" />
      <button id="btnApply">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
    </div>
    <div class="muted" style="margin-top:6px">‡πÉ‡∏ä‡πâ URL/Anon Key ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏•‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
  </div>

  <div class="card">
    <h3>2) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <div>Session: <span id="sess" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Ä¶</span></div>
    <div class="row" style="margin-top:8px">
      <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)" />
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
      <button id="btnPwd">Login ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
      <button id="btnOtp">‡∏™‡πà‡∏á Magic Link</button>
      <button id="btnOut" style="background:#e11d48">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>3) ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
    <div class="row" style="margin-bottom:8px">
      <button id="btnPing">üîé ping & ‡∏≠‡πà‡∏≤‡∏ô companies</button>
      <select id="company" style="min-width:260px"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option></select>
      <button id="btnLoadDocs">üìÑ ‡πÇ‡∏´‡∏•‡∏î product_registrations</button>
    </div>
    <div id="res1" class="muted"></div>
    <div style="margin-top:10px;overflow:auto">
      <table>
        <thead>
          <tr>
            <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th><th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</th><th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
$('origin').textContent=location.origin;
$('redir').textContent=new URL('admin.html',location.href).href;

// ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
$('url').value = "https://qmugpalgcktfwixqepti.supabase.co";
$('key').value = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";

let sb;
function makeClient(){
  const url=$('url').value.trim(), key=$('key').value.trim();
  if(!url||!key){ alert('‡∏Å‡∏£‡∏≠‡∏Å URL/KEY ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  sb = supabase.createClient(url,key);
}
$('btnApply').onclick = ()=>{ makeClient(); updateSession(); };

async function updateSession(){
  if(!sb) makeClient();
  $('sess').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Ä¶';
  const { data:{session}, error } = await sb.auth.getSession();
  $('sess').textContent = error ? ('‚ùå '+error.message) : (session ? ('‚úÖ '+(session.user.email||session.user.id)) : '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ (anonymous) ‚Äî');
}

$('btnPwd').onclick = async ()=>{
  if(!sb) makeClient();
  const email=$('email').value.trim(), pw=$('password').value;
  if(!email||!pw){ $('msg').textContent='‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô'; return; }
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  $('msg').textContent = error ? ('‚ùå '+error.message) : '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
  updateSession();
};

$('btnOtp').onclick = async ()=>{
  if(!sb) makeClient();
  const email=$('email').value.trim();
  if(!email){ $('msg').textContent='‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô'; return; }
  const { error } = await sb.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: new URL('admin.html', location.href).href }
  });
  $('msg').textContent = error ? ('‚ùå '+error.message) : '‚úÖ ‡∏™‡πà‡∏á Magic Link ‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏µ‡πÄ‡∏°‡∏•)';
};

$('btnOut').onclick = async ()=>{
  if(!sb) makeClient();
  await sb.auth.signOut(); $('msg').textContent='‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'; updateSession();
};

$('btnPing').onclick = async ()=>{
  if(!sb) makeClient();
  $('res1').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô companies‚Ä¶';
  const { data, error } = await sb.from('companies').select('code,name').order('name',{ascending:true});
  if(error){
    $('res1').innerHTML = `<span class="err">‚ùå ‡∏≠‡πà‡∏≤‡∏ô companies ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}</span>
    <div>‚Üí ‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å RLS/Policy ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ anonymous ‡∏´‡∏£‡∏∑‡∏≠ user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô</div>`;
  }else{
    $('res1').innerHTML = `<span class="ok">‚úÖ ‡πÑ‡∏î‡πâ ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
    $('company').innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>`;
    data.forEach(c=> $('company').innerHTML += `<option value="${c.code}">${c.name} (${c.code})</option>`);
  }
};

$('btnLoadDocs').onclick = async ()=>{
  if(!sb) makeClient();
  const code=$('company').value;
  if(!code){ alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const tb=$('tbody'); tb.innerHTML='<tr><td colspan="6" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>';
  const { data, error } = await sb.from('product_registrations').select('*').eq('company_code', code);
  if(error){
    tb.innerHTML = `<tr><td colspan="6" class="err">‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}</td></tr>`;
    return;
  }
  if(!data.length){ tb.innerHTML='<tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }
  tb.innerHTML='';
  data.forEach(r=>{
    tb.innerHTML += `<tr>
      <td>${r.company_code||'-'}</td>
      <td>${r.brand_name||'-'}</td>
      <td>${r.common_label||'-'}</td>
      <td>${r.registration_no||'-'}</td>
      <td>${r.license_no||'-'}</td>
      <td>${r.expiry_date||'-'}</td>
    </tr>`;
  });
};

// ‡∏™‡∏£‡πâ‡∏≤‡∏á client ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï session ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
makeClient();
updateSession();
</script>
</body>
</html>
