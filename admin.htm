<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin ‚Äî ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#0f172a;--card:#1e293b;--text:#e5eef7;--muted:#9fb0c6;--border:#2b3a4f;--accent:#3b82f6;--good:#10b981;--danger:#ef4444}
  body{font-family:ui-sans-serif,system-ui; background:linear-gradient(135deg,#0f172a 0%,#182235 100%); color:var(--text); padding:24px}
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:rgba(30,41,59,.92); border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:14px}
  h1{font-size:24px;font-weight:800;margin-bottom:6px}
  h3{margin-bottom:8px}
  .muted{color:var(--muted)}
  input,button{background:#0f172a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
  button{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#8b5cf6); border-color:transparent}
  .btn-good{background:linear-gradient(135deg,var(--good),#059669); border-color:transparent}
  .btn-danger{background:linear-gradient(135deg,var(--danger),#dc2626); border-color:transparent}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:rgba(59,130,246,.1);color:#b7cdfb}

  /* ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ */
  .tr-soon{background:rgba(245,158,11,.08);}
  .tr-expired{background:rgba(239,68,68,.10);}
  .badge-expiry{padding:4px 8px;border-radius:999px;font-size:12px}
  .badge-soon{color:#f59e0b;background:rgba(245,158,11,.08)}
  .badge-expired{color:#ef4444;background:rgba(239,68,68,.10)}
  .alert-expiry{display:none;margin-bottom:12px;padding:12px;border:1px solid rgba(245,158,11,.4);background:rgba(245,158,11,.08);color:#f59e0b;border-radius:10px}
  .alert-expiry.show{display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üõ†Ô∏è Admin ‚Äî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</h1>
    <div class="muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (owner/staff)</div>
  </div>

  <div class="card">
    <h3>üè≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3>
    <input id="companyCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡πÄ‡∏ä‡πà‡∏ô ABC)" style="text-transform:uppercase">
    <button id="btnSetCompany" class="btn-primary">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    <span class="muted">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong id="labelCompany">‚Äî</strong></span>
  </div>

  <div class="card">
    <h3 id="formTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
    <input id="brand_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
    <input id="common_label" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô validamycin 30% W/V SL)">
    <input id="registration_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
    <input id="license_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï">
    <input id="expiry_date" type="date">
    <input type="hidden" id="row_id">
    <button id="btnSave" class="btn-good">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="btnReset">‡∏•‡πâ‡∏≤‡∏á</button>
  </div>

  <div class="card">
    <h3>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h3>
    <input type="file" id="csvFile" accept=".csv">
    <button id="btnImport" class="btn-primary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
    <div class="muted">‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ: <code>brand_name, common_label, registration_no, license_no, expiry_date</code></div>
  </div>

  <div class="card">
    <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà)" style="width:260px">
    <button id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <span id="count" class="muted"></span>
  </div>

  <div class="card">
    <div id="expiryAlert" class="alert-expiry"></div>
    <table>
      <thead>
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
          <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</th>
          <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="8" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL='https://qmugpalgcktfwixqepti.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const $=id=>document.getElementById(id);
let CURRENT_COMPANY=(localStorage.getItem('company_code')||'').toUpperCase();
const WARNING_DAYS=3;

function fmtDate(d){if(!d)return'‚Äî';const t=new Date(d);return isNaN(t)?d:t.toLocaleDateString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit'});}
function daysLeft(d){if(!d)return null;const dd=new Date(d);if(isNaN(dd))return null;const today=new Date();today.setHours(0,0,0,0);return Math.ceil((dd-today)/(1000*60*60*24));}

async function loadRows(){
  $('labelCompany').textContent=CURRENT_COMPANY||'‚Äî';
  if(!CURRENT_COMPANY){$('tbody').innerHTML='<tr><td colspan="8" class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô</td></tr>';return;}
  const {data,error}=await sb.from('product_registrations').select('*').eq('company_code',CURRENT_COMPANY).order('created_at');
  if(error){$('tbody').innerHTML=`<tr><td colspan="8">${error.message}</td></tr>`;return;}
  const q=($('search').value||'').toLowerCase();
  let rows=(data||[]).filter(r=>!q||(r.brand_name||'').toLowerCase().includes(q)||(r.common_label||'').toLowerCase().includes(q)||(r.registration_no||'').toLowerCase().includes(q)||(r.license_no||'').toLowerCase().includes(q));
  $('count').textContent=rows.length?`‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`:'';

  let soon=0,exp=0;const alertBox=$('expiryAlert');
  $('tbody').innerHTML=rows.map((r,i)=>{
    const dl=daysLeft(r.expiry_date);let cls='',badge='',expCell=fmtDate(r.expiry_date);
    if(dl!==null){ if(dl<=0){cls='tr-expired';badge='<span class="badge-expiry badge-expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>';exp++;}
      else if(dl<=WARNING_DAYS){cls='tr-soon';badge=`<span class="badge-expiry badge-soon">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${dl} ‡∏ß‡∏±‡∏ô</span>`;soon++;} }
    return `<tr class="${cls}">
      <td>${i+1}</td>
      <td>${r.company_code||'-'}</td>
      <td>${r.brand_name||'-'}</td>
      <td>${r.common_label||'-'}</td>
      <td>${r.registration_no||'-'}</td>
      <td>${r.license_no||'-'}</td>
      <td>${expCell} ${badge}</td>
      <td>
        <button onclick="editRow('${r.id}')" class="btn-primary">‡πÅ‡∏Å‡πâ</button>
        <button onclick="deleteRow('${r.id}')" class="btn-danger">‡∏•‡∏ö</button>
      </td>
    </tr>`;
  }).join('');

  if(soon||exp){alertBox.classList.add('show');alertBox.innerHTML=`‚ö†Ô∏è ‡∏û‡∏ö ${exp?'‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß '+exp+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':''} ${soon?'‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‚â§3 ‡∏ß‡∏±‡∏ô) '+soon+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':''}`;}
  else{alertBox.classList.remove('show');alertBox.innerHTML='';}
}

async function saveRow(){
  if(!CURRENT_COMPANY)return alert('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload={company_code:CURRENT_COMPANY,brand_name:$('brand_name').value.trim(),common_label:$('common_label').value.trim(),
    registration_no:$('registration_no').value.trim(),license_no:$('license_no').value.trim()||null,expiry_date:$('expiry_date').value||null};
  if(!payload.brand_name||!payload.common_label||!payload.registration_no) return alert('‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£ / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡πà‡∏∞');
  const id=$('row_id').value;
  if(id){const {error}=await sb.from('product_registrations').update(payload).eq('id',id);if(error)return alert(error.message);}
  else {const {error}=await sb.from('product_registrations').insert(payload);if(error)return alert(error.message);}
  clearForm();loadRows();
}
function clearForm(){['brand_name','common_label','registration_no','license_no','expiry_date','row_id'].forEach(k=>$(k).value='');$('formTitle').textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';}
async function editRow(id){const {data,error}=await sb.from('product_registrations').select('*').eq('id',id).single();if(error)return alert(error.message);if(data){['brand_name','common_label','registration_no','license_no','expiry_date'].forEach(k=>$(k).value=data[k]||'');$('row_id').value=id;$('formTitle').textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';window.scrollTo({top:0,behavior:'smooth'});}}
async function deleteRow(id){if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?'))return;const {error}=await sb.from('product_registrations').delete().eq('id',id);if(error)return alert(error.message);loadRows();}

$('btnSetCompany').addEventListener('click',()=>{CURRENT_COMPANY=$('companyCode').value.toUpperCase();localStorage.setItem('company_code',CURRENT_COMPANY);loadRows();});
$('btnSave').addEventListener('click',saveRow);
$('btnReset').addEventListener('click',clearForm);
$('btnRefresh').addEventListener('click',loadRows);
$('search').addEventListener('input',loadRows);

// Import CSV (UTF-8, ‡∏°‡∏µ header)
$('btnImport').addEventListener('click',()=>{
  const file=$('csvFile').files[0]; if(!file) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞');
  const reader=new FileReader();
  reader.onload=async e=>{
    const text=e.target.result.replace(/\r/g,'');
    const lines=text.split('\n').filter(x=>x.trim().length);
    const headers=lines[0].split(',').map(h=>h.trim());
    const rows=lines.slice(1).map(l=>l.split(','));
    const payloads=rows.map(r=>{const obj={company_code:CURRENT_COMPANY};headers.forEach((h,i)=>obj[h]=r[i]?r[i].trim():null);return obj;});
    const {error}=await sb.from('product_registrations').insert(payloads);
    if(error) alert('Import ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message); else {alert('Import ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');loadRows();}
  };
  reader.readAsText(file);
});

document.addEventListener('DOMContentLoaded',()=>{$('companyCode').value=CURRENT_COMPANY;loadRows();});
</script>
</body>
</html>
