<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ‚Äî R.Good Service</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f9fafb;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#0ea5a5;
    --warn:#b45309;
    --danger:#b91c1c;
    --radius:14px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Prompt",sans-serif;
    color:var(--text);
    background:var(--bg);
  }
  header{
    padding:20px;
    background:linear-gradient(135deg,#e0f7f5,#f0fdfa);
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .logo{font-weight:700;font-size:20px;color:var(--accent);}
  main{max-width:1000px;margin:30px auto;padding:0 16px;}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:20px;
    margin-bottom:16px;
    box-shadow:0 3px 10px rgba(0,0,0,.05);
  }
  h2{margin-top:0;font-size:20px;color:var(--accent);}
  table{width:100%;border-collapse:collapse;font-size:15px;}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;}
  th{background:#f1f5f9;text-align:left;}
  .note{color:var(--muted);font-size:13px;}
  .status{font-weight:600;padding:4px 8px;border-radius:8px;display:inline-block;}
  .status[data-status="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"]{background:#fff7ed;color:var(--warn);}
  .status[data-status="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"]{background:#ecfdf5;color:#047857;}
  .status[data-status="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß"]{background:#fef2f2;color:var(--danger);}
  .filter-bar{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:16px;
    flex-wrap:wrap;
  }
  select{
    padding:8px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-family:"Prompt";
    font-size:14px;
    background:#fff;
  }
</style>
</head>
<body>
  <header>
    <div class="logo">üìÑ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
    <button onclick="history.length>1?history.back():window.close()" style="padding:8px 14px;border:1px solid var(--border);background:white;border-radius:10px;cursor:pointer;">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
  </header>

  <main>
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h2>
      <div id="companyName" class="note"></div>

      <div class="filter-bar">
        <label for="statusFilter">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞:</label>
        <select id="statusFilter">
          <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á+‡πÅ‡∏•‡πâ‡∏ß">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ + ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
          <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
          <option value="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
      </div>

      <table id="noteTable">
        <thead>
          <tr>
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" style="color:var(--muted)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

<script>
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allData = [];

async function loadNotes(){
  const params = new URLSearchParams(window.location.search);
  const code = (params.get('code') || '').trim().toUpperCase();
  
  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö code
  if(!code){
    document.getElementById('companyName').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
    document.querySelector('#noteTable tbody').innerHTML = 
      `<tr><td colspan="5" style="color:#b91c1c">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô URL ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</td></tr>`;
    return;
  }
  
  document.getElementById('companyName').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code}`;

  const { data, error } = await sb
    .from('product_registrations')
    .select('id,brand_name,common_label,renewed_status,renewed_note')
    .eq('company_code', code)
    .in('renewed_status', ['‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß','‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß'])
    .order('brand_name', { ascending: true });

  if(error){
    document.querySelector('#noteTable tbody').innerHTML = 
      `<tr><td colspan="5" style="color:#b91c1c">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${escapeHtml(error.message)}</td></tr>`;
    return;
  }

  allData = (data || []).map(r => ({
    ...r,
    renewed_status: r.renewed_status || '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'
  }));
  renderTable();
}

function renderTable(){
  const filter = document.getElementById('statusFilter').value;
  let filtered = allData;

  if(filter === '‡∏Å‡∏≥‡∏•‡∏±‡∏á+‡πÅ‡∏•‡πâ‡∏ß'){
    filtered = allData.filter(r => ['‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'].includes(r.renewed_status));
  }else if(filter !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'){
    filtered = allData.filter(r => r.renewed_status === filter);
  }

  const tb = document.querySelector('#noteTable tbody');
  if(filtered.length === 0){
    tb.innerHTML = `<tr><td colspan="5" style="color:#64748b">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${escapeHtml(r.brand_name)}</td>
      <td>${escapeHtml(r.common_label)}</td>
      <td><span class="status" data-status="${r.renewed_status}">${r.renewed_status}</span></td>
      <td>${r.renewed_note ? escapeHtml(r.renewed_note).replace(/\n/g,'<br>') : '-'}</td>
    </tr>
  `).join('');
}

function escapeHtml(s){
  return String(s ?? '-').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadNotes();
  document.getElementById('statusFilter').addEventListener('change', renderTable);
});
</script>
</body>
</html>
