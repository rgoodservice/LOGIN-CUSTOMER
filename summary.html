<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏ó‡πá‡∏ö 4 ‡∏ä‡πà‡∏≠‡∏á) ‚Äî R.Good Service</title>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6fbff; --card:#ffffff; --border:#e6eef5; --ink:#0f172a; --mut:#64748b;
    --accent:#0ea5a5; --accent2:#60a5fa; --radius:16px;
    --ok:#065f46;   --okbg:#ecfdf5;
    --warn:#b45309; --warnbg:#fff7ed;
    --exp:#b91c1c;  --expbg:#fff1f2;
    --note:#334155;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Prompt",ui-sans-serif,system-ui; color:var(--ink); background:
    radial-gradient(1000px 500px at 10% -10%, #e6f7ff 0%, transparent 60%),
    radial-gradient(900px 450px at 110% 0%, #e8fff6 0%, transparent 60%),
    #f6fbff;
  }
  header{
    padding:18px; background:linear-gradient(135deg,#e0f7f5,#f0fdfa);
    border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px
  }
  .logo{font-weight:700; font-size:22px; color:#0b3a4f}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:18px; margin-bottom:14px; box-shadow:0 6px 22px rgba(10,30,60,.06)
  }
  h2{margin:0 0 10px; font-size:20px; color:#0b3a4f}
  .mut{color:var(--mut)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  input, select, button{
    padding:12px; border-radius:12px; border:1px solid var(--border); background:#fff;
    font-size:18px; color:var(--ink)
  }
  .btn{cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700; border:none}
  .btn-ghost{background:#fff; color:#0e7490; border:1px solid #94d5e5}
  .pill{
    padding:8px 14px; border-radius:999px; border:1px solid var(--border); background:#fff;
    cursor:pointer; font-weight:700; font-size:18px;
  }
  .pill.active{ background:linear-gradient(135deg,#eaf7ff,#f0fdfa); border-color:#9bd5e9 }
  .pill .count{margin-left:8px; font-weight:700; color:#0ea5a5}

  .item{
    border:1px solid var(--border); border-radius:14px; padding:14px; margin:10px 0;
    background:#fff; box-shadow:0 3px 14px rgba(10,30,60,.05)
  }
  .item h3{margin:0 0 6px; font-size:20px}
  .sub{color:#475569; font-size:17px; margin-bottom:8px}
  .grid{
    display:grid; grid-template-columns: 1fr 1fr; gap:8px 14px; margin-top:8px
  }
  .kv{font-size:16px}
  .kv b{display:inline-block; min-width:110px; color:#334155}
  .badge{padding:6px 12px; border-radius:999px; font-weight:700; display:inline-block; font-size:16px}
  .ok{ color:var(--ok);   background:var(--okbg);   border:1px solid #a7f3d090; }
  .warn{color:var(--warn); background:var(--warnbg); border:1px solid #fde68a80;}
  .exp{ color:var(--exp);  background:var(--expbg);  border:1px solid #fecaca90;}
  .note{color:var(--note); background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:10px; font-size:16px; white-space:pre-wrap}

  .tab-wrap{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px}
  .empty{color:var(--mut); font-size:18px; padding:14px}
</style>
</head>
<body>
<header>
  <div class="logo">üóÇÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏ó‡πá‡∏ö 4 ‡∏ä‡πà‡∏≠‡∏á)</div>
  <div class="spacer"></div>
  <button class="btn-ghost" onclick="history.length>1?history.back():window.close()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
</header>

<main class="wrap">
  <div class="card">
    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
    <div id="companyName" class="mut" style="margin-bottom:10px">‚Äî</div>

    <div class="row" style="margin-bottom:10px">
      <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç" style="min-width:260px">
      <button id="clearBtn" class="btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <div class="spacer"></div>
      <button id="refreshBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>

    <div class="tab-wrap">
      <button class="pill active" data-tab="near"><span>‡πÉ‡∏Å‡∏•‡πâ/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span> <span class="count" id="cnt-near">0</span></button>
      <button class="pill" data-tab="inprog"><span>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span> <span class="count" id="cnt-inprog">0</span></button>
      <button class="pill" data-tab="stopped"><span>‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span> <span class="count" id="cnt-stopped">0</span></button>
      <button class="pill" data-tab="done"><span>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span> <span class="count" id="cnt-done">0</span></button>
    </div>

    <div id="count" class="mut">‚Äî</div>
  </div>

  <div class="card" id="tab-near">
    <h2>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
    <div id="list-near" class="list"></div>
  </div>

  <div class="card" id="tab-inprog" style="display:none">
    <h2>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
    <div id="list-inprog" class="list"></div>
  </div>

  <div class="card" id="tab-stopped" style="display:none">
    <h2>‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</h2>
    <div id="list-stopped" class="list"></div>
  </div>

  <div class="card" id="tab-done" style="display:none">
    <h2>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</h2>
    <div id="list-done" class="list"></div>
  </div>
</main>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== Utils & State ===== */
const $ = (id)=>document.getElementById(id);
const WARNING_DAYS = 90;

function fmtDateBE(d){
  if(!d) return '-';
  const t = new Date(d); if(isNaN(t)) return '-';
  try{
    return t.toLocaleDateString('th-TH-u-ca-buddhist', {year:'numeric', month:'short', day:'numeric', timeZone:'Asia/Bangkok'});
  }catch(e){
    return `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()+543}`;
  }
}
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function deriveStatus(row){
  // helper: ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢
  const norm = (s)=> String(s||'')
    .replace(/[\u200B-\u200D\uFEFF]/g,'') // ‡∏•‡∏ö zero-width
    .replace(/\s+/g,'')                   // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    .toLowerCase();

  const s1 = norm(row.renewed_status);
  const s2 = norm(row.status_text);
  const s3 = norm(row.renewed_note);
  const all = s1 + '|' + s2 + '|' + s3;

  // 0) ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏ä‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
  if (all.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏')) return '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';

  // 1) ‡∏°‡∏µ renewed_until = ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
  if (row.renewed_until) return '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';

  // 2) ‡∏Ñ‡∏≥‡∏û‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"
  const DONE_KEYS = [
    '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß','‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß',
    '‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠','‡∏¢‡∏∑‡πà‡∏ô‡∏Ç‡∏≠','‡∏¢‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏','‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£','‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠','‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
    '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á','‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠','‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤',
    '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
    '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à','‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï','‡∏£‡∏≠‡∏•‡∏á‡∏ô‡∏≤‡∏°',
    '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß'
  ];
  if (DONE_KEYS.some(k => all.includes(norm(k)))) return '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';

  // 3) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™ "‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö/‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠" = ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  const INPROG_KEYS = [
    '‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö','‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö','‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏',
    '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏','‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô','‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°','‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞',
    '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠','‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏≠‡∏ö'
  ];
  if (INPROG_KEYS.some(k => all.includes(norm(k)))) return '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';

  // 4) ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Üí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏Å‡∏•‡πâ/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)
  return null;
}



function computeBadge(row){
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ bucket ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ bucket ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
  if (row._bucket === 'inprog')  return `<span class="badge warn">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
  if (row._bucket === 'stopped') return `<span class="badge exp">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>`;
  if (row._bucket === 'done')    return `<span class="badge ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`;

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏ß‡∏î ‡πÉ‡∏Ç‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å
  if(!row.expiry_date) return `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
  const diff = Math.ceil((new Date(row.expiry_date) - new Date())/86400000);
  if(diff < 0) return `<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`;
  if(diff <= WARNING_DAYS) return `<span class="badge warn">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
  return `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
}


function inNearBucket(row){
  // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß / ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß / ‡∏°‡∏µ renewed_until ‡πÅ‡∏•‡πâ‡∏ß
  if (row._bucket === 'inprog' || row._bucket === 'stopped' || row._bucket === 'done' || row.renewed_until) return false;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á
  if (!row.expiry_date) return false;

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô "‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏"
  const diff = Math.ceil((new Date(row.expiry_date) - new Date())/86400000);
  return diff <= WARNING_DAYS;
}


let FULL = [];
let FILTER_Q = '';
let GROUPS = { near:[], inprog:[], stopped:[], done:[] };
let REALTIME_CH = null;       // ‡∏ä‡πà‡∏≠‡∏á realtime
let COMPANY_CODE_REAL = null; // code ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏à‡∏≤‡∏Å v2 RPC)

function applyFilterAndGroup(){
  const q = FILTER_Q.toLowerCase();

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const rows = FULL.filter(r=>{
    if(!q) return true;
    return ((r.brand_name||'').toLowerCase().includes(q) ||
            (r.common_label||'').toLowerCase().includes(q));
  });

  // ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏¥‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á + ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏™‡∏£‡∏¥‡∏°
  const norm = s => String(s||'').replace(/\s+/g,'');
  const isInprog = (r)=>{
    const ds  = deriveStatus(r);
    const raw = norm(r.renewed_status);
    return ds === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || /‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/.test(raw);
  };
  const isStopped = (r)=>{
    const ds  = deriveStatus(r);
    const raw = norm(r.renewed_status);
    return ds === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' || /‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß/.test(raw);
  };
  const isDone = (r)=>{
    const ds  = deriveStatus(r);
    const raw = norm(r.renewed_status);
    return !!r.renewed_until || ds === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' || /‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß/.test(raw);
  };
  const inNearBucket = (r)=>{
    if (isInprog(r) || isStopped(r) || isDone(r)) return false;
    if (!r.expiry_date) return false;
    const diff = Math.ceil((new Date(r.expiry_date) - new Date())/86400000);
    return (diff <= WARNING_DAYS);
  };

  // ‡∏ï‡∏¥‡∏î bucket ‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
  rows.forEach(r=>{
    if (isStopped(r)) r._bucket = 'stopped';
    else if (isDone(r)) r._bucket = 'done';
    else if (isInprog(r)) r._bucket = 'inprog';
    else if (inNearBucket(r)) r._bucket = 'near';
    else r._bucket = null;
  });

  // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° bucket ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡πÑ‡∏ß‡πâ
  GROUPS.inprog  = rows.filter(r=> r._bucket === 'inprog');
  GROUPS.stopped = rows.filter(r=> r._bucket === 'stopped');
  GROUPS.done    = rows.filter(r=> r._bucket === 'done');
  GROUPS.near    = rows.filter(r=> r._bucket === 'near');

  $('cnt-near').textContent    = GROUPS.near.length.toLocaleString('th-TH');
  $('cnt-inprog').textContent  = GROUPS.inprog.length.toLocaleString('th-TH');
  $('cnt-stopped').textContent = GROUPS.stopped.length.toLocaleString('th-TH');
  $('cnt-done').textContent    = GROUPS.done.length.toLocaleString('th-TH');

  $('count').textContent = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${FILTER_Q || '‚Äî'}" ‡∏£‡∏ß‡∏° ${rows.length.toLocaleString('th-TH')} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}


function renderList(listId, rows){
  const box = $(listId);
  if(rows.length === 0){ box.innerHTML = `<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`; return; }

  const sorted = [...rows].sort((a,b)=>{
    const tA = a.renewed_on ? new Date(a.renewed_on).getTime() : 0;
    const tB = b.renewed_on ? new Date(b.renewed_on).getTime() : 0;
    if (listId==='list-near'){
      const dA = a.expiry_date ? new Date(a.expiry_date).getTime() : Infinity;
      const dB = b.expiry_date ? new Date(b.expiry_date).getTime() : Infinity;
      return dA - dB;
    }
    if (listId==='list-stopped') return tB - tA;
    return tB - tA;
  });

  box.innerHTML = sorted.map(r=>`
    <div class="item">
      <h3>${escapeHtml(r.brand_name||'-')}</h3>
      <div class="sub">${escapeHtml(r.common_label||'-')}</div>
      <div class="grid">
        <div class="kv"><b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> ${escapeHtml(r.registration_no||'-')}</div>
        <div class="kv"><b>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</b> ${escapeHtml(r.license_no||'-')}</div>
        <div class="kv"><b>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏¥‡∏°:</b> ${fmtDateBE(r.expiry_date)}</div>
        <div class="kv"><b>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</b> ${fmtDateBE(r.renewed_on)}</div>
        <div class="kv"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${computeBadge(r)}</div>
      </div>
      ${ r.renewed_note ? `<div class="note" style="margin-top:10px"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b>\n${escapeHtml(r.renewed_note)}</div>` : ``}
    </div>
  `).join('');
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (RPC v2 ‡πÄ‡∏™‡∏°‡∏≠) ===== */
async function fetchAndRender(code){
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó + company_code ‡∏à‡∏£‡∏¥‡∏á (‡∏à‡∏≤‡∏Å v2)
  const nameRes = await sb.rpc('get_company_name_by_code_v2', { p_plain_code: code });
  COMPANY_CODE_REAL = nameRes.data || null; // ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏µ‡∏°‡∏≤ v2 ‡∏Ñ‡∏∑‡∏ô c.code (= company_code ‡∏à‡∏£‡∏¥‡∏á)
  $('companyName').textContent = COMPANY_CODE_REAL
    ? `‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${COMPANY_CODE_REAL} (‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code})`
    : `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code}`;

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const res = await sb.rpc('get_company_portal_v2', { p_plain_code: code });
  if(res.error){
    $('companyName').textContent += ` ‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${res.error.message}`;
    return;
  }

  FULL = (res.data||[]).map(x => ({ ...x, _derived_status: deriveStatus(x) }));
  applyFilterAndGroup();
  renderList('list-near',    GROUPS.near);
  renderList('list-inprog',  GROUPS.inprog);
  renderList('list-stopped', GROUPS.stopped);
  renderList('list-done',    GROUPS.done);
}

/* ===== Realtime: subscribe table changes for this company ===== */
function setupRealtime(){
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
  if(REALTIME_CH){
    sb.removeChannel(REALTIME_CH);
    REALTIME_CH = null;
  }
  if(!COMPANY_CODE_REAL) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ company_code ‡∏à‡∏£‡∏¥‡∏á

  REALTIME_CH = sb.channel('cust-portal-' + COMPANY_CODE_REAL)
    .on('postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'product_registrations',
        filter: `company_code=eq.${COMPANY_CODE_REAL}`
      },
      (payload) => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ insert/update/delete ‚Üí ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        // ‡πÉ‡∏ä‡πâ code ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL ‡πÄ‡∏î‡∏¥‡∏°
        const params = new URLSearchParams(location.search);
        const code = (params.get('code')||'').trim().toUpperCase();
        fetchAndRender(code);
      }
    )
    .subscribe();
}

/* ===== Flow ‡∏´‡∏•‡∏±‡∏Å ===== */
async function loadData(){
  const params = new URLSearchParams(location.search);
  const code = (params.get('code')||'').trim().toUpperCase();
  if(!code){ $('companyName').textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤ (?code=...)'; return; }

  await fetchAndRender(code);  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
  setupRealtime();             // ‡∏ï‡∏±‡πâ‡∏á realtime ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ
}

/* ===== Tabs & Events ===== */
function switchTab(key){
  document.querySelectorAll('.pill').forEach(el=>{
    el.classList.toggle('active', el.dataset.tab === key);
  });
  $('tab-near').style.display    = (key==='near')?'block':'none';
  $('tab-inprog').style.display  = (key==='inprog')?'block':'none';
  $('tab-stopped').style.display = (key==='stopped')?'block':'none';
  $('tab-done').style.display    = (key==='done')?'block':'none';
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadData();

  document.querySelectorAll('.pill').forEach(btn=>{
    btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
  });

  $('q').addEventListener('input', ()=>{
    FILTER_Q = $('q').value.trim();
    applyFilterAndGroup();
    renderList('list-near',    GROUPS.near);
    renderList('list-inprog',  GROUPS.inprog);
    renderList('list-stopped', GROUPS.stopped);
    renderList('list-done',    GROUPS.done);
  });

  $('clearBtn').addEventListener('click', ()=>{
    $('q').value=''; FILTER_Q='';
    applyFilterAndGroup();
    renderList('list-near',    GROUPS.near);
    renderList('list-inprog',  GROUPS.inprog);
    renderList('list-stopped', GROUPS.stopped);
    renderList('list-done',    GROUPS.done);
  });

  $('refreshBtn').addEventListener('click', loadData);
});

// ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå realtime channel ‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
window.addEventListener('beforeunload', ()=>{
  if(REALTIME_CH) sb.removeChannel(REALTIME_CH);
});
</script>
</body>
</html>
