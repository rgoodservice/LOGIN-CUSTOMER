<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Äî R.Good Service</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6fbff; --card:#ffffff; --border:#e6eef5; --ink:#0f172a; --mut:#64748b;
    --accent:#0ea5a5; --accent2:#60a5fa; --radius:16px;
    --ok:#065f46;   --okbg:#ecfdf5;
    --warn:#b45309; --warnbg:#fff7ed;
    --exp:#b91c1c;  --expbg:#fff1f2;
    --note:#334155;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Prompt",ui-sans-serif,system-ui; color:var(--ink); background:
    radial-gradient(1000px 500px at 10% -10%, #e6f7ff 0%, transparent 60%),
    radial-gradient(900px 450px at 110% 0%, #e8fff6 0%, transparent 60%),
    #f6fbff;
  }
  header{
    padding:18px; background:linear-gradient(135deg,#e0f7f5,#f0fdfa);
    border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px
  }
  .logo{font-weight:700; font-size:22px; color:#0b3a4f}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:18px; margin-bottom:14px; box-shadow:0 6px 22px rgba(10,30,60,.06)
  }
  h2{margin:0 0 10px; font-size:20px; color:#0b3a4f}
  .mut{color:var(--mut)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  input, select, button{
    padding:12px; border-radius:12px; border:1px solid var(--border); background:#fff;
    font-size:18px; color:var(--ink)
  }
  .btn{cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700; border:none}
  .btn-ghost{background:#fff; color:#0e7490; border:1px solid #94d5e5}
  .pill{
    padding:8px 14px; border-radius:999px; border:1px solid var(--border); background:#fff;
    cursor:pointer; font-weight:700; font-size:18px;
  }
  .pill.active{ background:linear-gradient(135deg,#eaf7ff,#f0fdfa); border-color:#9bd5e9 }
  .pill .count{margin-left:8px; font-weight:700; color:#0ea5a5}

  .item{
    border:1px solid var(--border); border-radius:14px; padding:14px; margin:10px 0;
    background:#fff; box-shadow:0 3px 14px rgba(10,30,60,.05)
  }
  .item h3{margin:0 0 6px; font-size:20px}
  .sub{color:#475569; font-size:17px; margin-bottom:8px}
  .grid{
    display:grid; grid-template-columns: 1fr 1fr; gap:8px 14px; margin-top:8px
  }
  .kv{font-size:16px}
  .kv b{display:inline-block; min-width:110px; color:#334155}
  .badge{padding:6px 12px; border-radius:999px; font-weight:700; display:inline-block; font-size:14px; margin-right:4px; margin-bottom:4px;}
  .ok{ color:var(--ok);   background:var(--okbg);   border:1px solid #a7f3d090; }
  .warn{color:var(--warn); background:var(--warnbg); border:1px solid #fde68a80;}
  .exp{ color:var(--exp);   background:var(--expbg);   border:1px solid #fecaca90;}
  .note{color:var(--note); background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:10px; font-size:16px; white-space:pre-wrap; margin-top:10px;}

  .tab-wrap{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px}
  .empty{color:var(--mut); font-size:18px; padding:14px}
</style>
</head>
<body>
<header>
  <div class="logo">üóÇÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
  <div class="spacer"></div>
  <button class="btn-ghost" onclick="history.length>1?history.back():window.close()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
</header>

<main class="wrap">
  <div class="card">
    <h2 id="companyName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç" style="min-width:260px">
      <button id="clearBtn" class="btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <div class="spacer"></div>
      <button id="refreshBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>

    <div class="tab-wrap">
      <button class="pill active" data-tab="near"><span>‡πÉ‡∏Å‡∏•‡πâ/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span> <span class="count" id="cnt-near">0</span></button>
      <button class="pill" data-tab="inprog"><span>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span> <span class="count" id="cnt-inprog">0</span></button>
      <button class="pill" data-tab="stopped"><span>‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span> <span class="count" id="cnt-stopped">0</span></button>
      <button class="pill" data-tab="done"><span>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span> <span class="count" id="cnt-done">0</span></button>
    </div>
  </div>

  <div id="tab-near" class="card tab-content">
    <h2>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
    <div id="list-near" class="list"></div>
  </div>

  <div id="tab-inprog" class="card tab-content" style="display:none">
    <h2>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
    <div id="list-inprog" class="list"></div>
  </div>

  <div id="tab-stopped" class="card tab-content" style="display:none">
    <h2>‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</h2>
    <div id="list-stopped" class="list"></div>
  </div>

  <div id="tab-done" class="card tab-content" style="display:none">
    <h2>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</h2>
    <div id="list-done" class="list"></div>
  </div>
</main>

<script>
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = (id)=>document.getElementById(id);
const WARNING_DAYS = 90;
let FULL_ROWS = [];
let GROUPS = { near:[], inprog:[], stopped:[], done:[] };

function fmtDateBE(d){
  if(!d) return '-';
  const t = new Date(d);
  return t.toLocaleDateString('th-TH-u-ca-buddhist', {year:'numeric', month:'short', day:'numeric'});
}

function escapeHtml(s){return String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* 1. Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Bucketing) */
function getBucket(row){
  const status = row.renewed_status || '';
  const note = row.renewed_note || '';

  // 1. ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏
  if (status.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß')) return 'stopped';
  
  // 2. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
  if (status.includes('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') || row.renewed_until) return 'done';

  // 3. ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)
  if (status.includes('‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') || 
      status.includes('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö') || 
      status.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£') ||
      note.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') ||
      note.includes('‡∏•‡∏á‡∏ô‡∏≤‡∏°')) {
    return 'inprog';
  }

  // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  if (row.expiry_date) {
    const diff = Math.ceil((new Date(row.expiry_date) - new Date())/86400000);
    if (diff <= WARNING_DAYS) return 'near';
  }

  return 'other';
}

/* 2. Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ (Double Badge) */
function computeBadge(row){
  const st = row.renewed_status || '';
  
  if(st.includes('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') || row.renewed_until) {
    return `<span class="badge ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`;
  }

  let dayBadge = '';
  if(row.expiry_date) {
    const diff = Math.ceil((new Date(row.expiry_date) - new Date())/86400000);
    if(diff < 0) dayBadge = '<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>';
    else if(diff <= WARNING_DAYS) dayBadge = `<span class="badge warn">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
    else dayBadge = '<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
  }

  if(st === '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤')
    return `<span class="badge warn" style="background:#fef3c7; color:#92400e; border:1px solid #fcd34d">üì¢ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</span> ${dayBadge}`;
  
  if(st === '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏')
    return `<span class="badge ok" style="background:#e0f2fe; color:#075985; border:1px solid #bae6fd">üìÑ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span> ${dayBadge}`;
  
  if(st.includes('‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á'))
    return `<span class="badge warn">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span> ${dayBadge}`;

  return dayBadge;
}

function render(){
  const q = ($('q').value || '').toLowerCase();
  GROUPS = { near:[], inprog:[], stopped:[], done:[] };

  FULL_ROWS.forEach(r => {
    if (q && !r.brand_name.toLowerCase().includes(q) && !r.common_label.toLowerCase().includes(q)) return;
    const bucket = getBucket(r);
    if (GROUPS[bucket]) GROUPS[bucket].push(r);
  });

  ['near','inprog','stopped','done'].forEach(key => {
    $( `cnt-${key}` ).textContent = GROUPS[key].length.toLocaleString('th-TH');
    const box = $( `list-${key}` );
    if (GROUPS[key].length === 0) {
      box.innerHTML = '<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>';
      return;
    }
    box.innerHTML = GROUPS[key].map(r => `
      <div class="item">
        <h3>${escapeHtml(r.brand_name)}</h3>
        <div class="sub">${escapeHtml(r.common_label)}</div>
        <div class="grid">
          <div class="kv"><b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> ${escapeHtml(r.registration_no || '-')}</div>
          <div class="kv"><b>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏¥‡∏°:</b> ${fmtDateBE(r.expiry_date)}</div>
          <div class="kv"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${computeBadge(r)}</div>
        </div>
        ${r.renewed_note ? `<div class="note"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b><br>${escapeHtml(r.renewed_note)}</div>` : ''}
      </div>
    `).join('');
  });
}

async function loadData(){
  const params = new URLSearchParams(location.search);
  const code = (params.get('code')||'').trim().toUpperCase();
  
  if(!code) {
    $('companyName').textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô URL";
    return;
  }

  // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
  const { data, error } = await sb.rpc('get_company_portal_v2', { p_plain_code: code });
  
  if (error || !data || data.length === 0) {
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    $('companyName').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code}`;
    FULL_ROWS = [];
  } else {
    // 2. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÑ‡∏î‡πâ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå company_name)
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ó‡∏ô
    const realName = data[0].company_name || `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (${code})`;
    $('companyName').textContent = realName;
    
    FULL_ROWS = data;
  }

  // 3. ‡∏™‡∏±‡πà‡∏á Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  render();
}
document.querySelectorAll('.pill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    $( `tab-${btn.dataset.tab}` ).style.display = 'block';
  });
});

$('q').addEventListener('input', render);
$('clearBtn').addEventListener('click', () => { $('q').value=''; render(); });
$('refreshBtn').addEventListener('click', loadData);
window.onload = loadData;
</script>
</body>
</html>
