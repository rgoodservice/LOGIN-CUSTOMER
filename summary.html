<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (3 ‡∏ö‡∏•‡πá‡∏≠‡∏Å) ‚Äî R.Good Service</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6fbff; --card:#ffffff; --border:#e6eef5; --ink:#0f172a; --mut:#64748b;
    --accent:#0ea5a5; --accent2:#60a5fa; --radius:16px;
    --ok:#0b7a58;   --okbg:#e9fbf3;
    --warn:#b45309; --warnbg:#fff3e6;
    --exp:#b91c1c;  --expbg:#ffecec;
    --note-bg:#e0f2fe; --note-text:#0c4a6e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Prompt",sans-serif; color:var(--ink);
    background:linear-gradient(180deg,#f0fdfa,#f6fbff);
  }
  header{
    padding:18px; background:linear-gradient(135deg,#e0f7f5,#f0fdfa);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .logo{font-weight:700;font-size:22px;color:#0b3a4f}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:18px; margin-bottom:14px; box-shadow:0 6px 22px rgba(10,30,60,.06)
  }
  h2{margin:0 0 10px;font-size:20px;color:#0b3a4f}
  .mut{color:var(--mut)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{
    padding:12px;border-radius:12px;border:1px solid var(--border);
    font-size:18px;
  }
  .btn{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:700;cursor:pointer;border:none}
  .btn-ghost{background:#fff;color:#0e7490;border:1px solid #94d5e5;cursor:pointer}
  .pill{padding:10px 16px;border-radius:999px;border:1px solid #94d5e5;background:#f0fdfa;cursor:pointer;font-weight:700;font-size:18px}
  .pill.active{background:linear-gradient(135deg,#eaf7ff,#f0fdfa)}
  .pill .count{margin-left:8px;color:#0ea5a5}

  /* Accordion */
  .blk-head{
    width:100%;text-align:left;background:#fff;border:1px solid var(--border);
    border-radius:12px;padding:14px 16px;font-size:18px;font-weight:700;
    display:flex;align-items:center;justify-content:space-between;cursor:pointer;
  }
  .blk-head .hint{font-weight:600;color:#0ea5a5}
  .blk-body{padding:10px 0 2px}

  /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
  .item{
    border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0;
    background:#fff;box-shadow:0 3px 14px rgba(10,30,60,.05)
  }
  .item h3{margin:0 0 8px;font-size:22px}
  .sub{color:#475569;font-size:18px;margin-bottom:10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px}
  .kv{font-size:18px}
  .kv b{display:inline-block;min-width:120px;color:#334155}
  .badge{padding:8px 14px;border-radius:999px;font-weight:700;display:inline-block;font-size:18px}
  .ok{color:var(--ok);background:var(--okbg);border:1px solid #b6f0d0}
  .warn{color:var(--warn);background:var(--warnbg);border:1px solid #ffd7a6}
  .exp{color:var(--exp);background:var(--expbg);border:1px solid #ffc0c0}
  .note{
    background:var(--note-bg);color:var(--note-text);
    border-radius:10px;padding:12px;font-size:18px;margin-top:10px;
    white-space:pre-wrap;
  }
  .empty{color:var(--mut);font-size:18px;padding:14px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="logo">üóÇÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (3 ‡∏ö‡∏•‡πá‡∏≠‡∏Å)</div>
  <button class="btn-ghost" onclick="history.back()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
</header>

<main class="wrap">
  <div class="card">
    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
    <div id="companyName" class="mut" style="margin-bottom:10px">‚Äî</div>

    <div class="row" style="margin-bottom:10px">
      <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç" style="min-width:260px">
      <button id="clearBtn" class="btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <button id="refreshBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
  </div>

  <!-- ‡∏ö‡∏•‡πá‡∏≠‡∏Å 1 -->
  <div class="card">
    <button class="blk-head" data-collapse="near">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ <span class="hint">(‡πÅ‡∏™‡∏î‡∏á)</span></button>
    <div class="blk-body" id="list-near"></div>
  </div>

  <!-- ‡∏ö‡∏•‡πá‡∏≠‡∏Å 2 -->
  <div class="card">
    <button class="blk-head" data-collapse="progress">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß <span class="hint">(‡πÅ‡∏™‡∏î‡∏á)</span></button>
    <div class="blk-body" id="list-progress"></div>
  </div>

  <!-- ‡∏ö‡∏•‡πá‡∏≠‡∏Å 3 -->
  <div class="card">
    <button class="blk-head" data-collapse="stopped">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß <span class="hint">(‡πÅ‡∏™‡∏î‡∏á)</span></button>
    <div class="blk-body" id="list-stopped"></div>
  </div>
</main>

<script>
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const $ = id => document.getElementById(id);
const WARNING_DAYS = 90;

function fmtDateBE(d){
  if(!d) return "-";
  const t=new Date(d);if(isNaN(t))return"-";
  return t.toLocaleDateString("th-TH-u-ca-buddhist",{year:"numeric",month:"short",day:"numeric",timeZone:"Asia/Bangkok"});
}
function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

let FULL=[];

function badge(row){
  if(row.renewed_status==="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")return`<span class="badge warn">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
  if(row.renewed_status==="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß")return`<span class="badge exp">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>`;
  if(row.renewed_status==="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"||row.renewed_until)return`<span class="badge ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`;
  if(!row.expiry_date)return`<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
  const diff=Math.ceil((new Date(row.expiry_date)-new Date())/86400000);
  if(diff<0)return`<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`;
  if(diff<=WARNING_DAYS)return`<span class="badge warn">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
  return`<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
}

function inNear(row){
  if(["‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£","‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß","‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"].includes(row.renewed_status)||row.renewed_until)return false;
  if(!row.expiry_date)return false;
  const diff=Math.ceil((new Date(row.expiry_date)-new Date())/86400000);
  return diff<=WARNING_DAYS;
}

async function loadData(){
  const params=new URLSearchParams(location.search);
  const code=(params.get("code")||"").trim().toUpperCase();
  if(!code){$("companyName").textContent="‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤ (?code=...)";return;}
  const nameRes=await sb.rpc("get_company_name_by_code",{p_plain_code:code});
  $("companyName").textContent=nameRes.data?`‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${nameRes.data} (‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code})`:`‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code}`;
  const res=await sb.rpc("get_company_portal",{p_plain_code:code});
  if(res.error){$("companyName").textContent+=" ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";return;}
  FULL=(res.data||[]).map(x=>({...x,renewed_status:x.renewed_status||(x.renewed_until?"‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß":null)}));
  render();
}

function render(){
  const q=$("q").value.trim().toLowerCase();
  const rows=FULL.filter(r=>!q||r.brand_name?.toLowerCase().includes(q)||r.common_label?.toLowerCase().includes(q));

  const near=rows.filter(inNear);
  const progress=rows.filter(r=>["‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£","‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"].includes(r.renewed_status)||r.renewed_until);
  const stopped=rows.filter(r=>r.renewed_status==="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß");

  renderList("list-near",near);
  renderList("list-progress",progress);
  renderList("list-stopped",stopped);
}

function renderList(id,rows){
  const el=$(id);
  if(rows.length===0){el.innerHTML=`<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;return;}
  el.innerHTML=rows.map(r=>`
    <div class="item">
      <h3>${escapeHtml(r.brand_name||"-")}</h3>
      <div class="sub">${escapeHtml(r.common_label||"-")}</div>
      <div class="grid">
        <div class="kv"><b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> ${escapeHtml(r.registration_no||"-")}</div>
        <div class="kv"><b>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</b> ${escapeHtml(r.license_no||"-")}</div>
        <div class="kv"><b>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏¥‡∏°:</b> ${fmtDateBE(r.expiry_date)}</div>
        <div class="kv"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${badge(r)}</div>
      </div>
      ${r.renewed_note?`<div class="note"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${escapeHtml(r.renewed_note)}</div>`:""}
    </div>`).join("");
}

document.addEventListener("DOMContentLoaded",()=>{
  loadData();
  $("q").addEventListener("input",render);
  $("clearBtn").addEventListener("click",()=>{$("q").value="";render();});
  $("refreshBtn").addEventListener("click",loadData);
  document.querySelectorAll(".blk-head").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const body=btn.nextElementSibling;
      const hint=btn.querySelector(".hint");
      const show=body.style.display!=="none";
      body.style.display=show?"none":"block";
      hint.textContent=show?"(‡∏ã‡πà‡∏≠‡∏ô)":"(‡πÅ‡∏™‡∏î‡∏á)";
    });
  });
});
</script>
</body>
</html>
