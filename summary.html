<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‚Äî R.Good Service</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f9fafb;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#0ea5a5;
    --warn:#b45309;
    --danger:#b91c1c;
    --ok:#047857;
    --radius:14px;

    /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô */
    --bg-inprog:#fff8e1;  /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
    --bg-done:#ecfdf5;    /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
    --bg-stop:#ffecec;    /* ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Prompt",sans-serif;
    color:var(--text);
    background:var(--bg);
  }
  header{
    padding:20px;
    background:linear-gradient(135deg,#e0f7f5,#f0fdfa);
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .spacer{flex:1}
  .logo{font-weight:700;font-size:20px;color:var(--accent);}
  .btn{
    padding:8px 14px;border:1px solid var(--border);background:white;border-radius:10px;cursor:pointer;
    font-family:"Prompt"; font-size:14px;
  }
  main{
    max-width:1000px;
    margin:30px auto;
    padding:0 16px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:20px;
    margin-bottom:16px;
    box-shadow:0 3px 10px rgba(0,0,0,.05);
  }
  h2{margin-top:0;font-size:20px;color:var(--accent);}
  table{width:100%;border-collapse:collapse;font-size:15px;}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;}
  th{background:#f1f5f9;text-align:left;}
  tr[data-status="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"]{background:var(--bg-inprog);}
  tr[data-status="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"]{background:var(--bg-done);}
  tr[data-status="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß"]{background:var(--bg-stop);}
  .note{color:var(--muted);font-size:13px;}
  .status{font-weight:600;padding:4px 8px;border-radius:8px;display:inline-block;}
  .status[data-status="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"]{background:#fff7ed;color:var(--warn);}
  .status[data-status="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß"]{background:#fef2f2;color:var(--danger);}
  .status[data-status="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß"]{background:#ecfdf5;color:var(--ok);}
  .filter-bar{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:16px;
  }
  select{
    padding:8px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-family:"Prompt";
    font-size:14px;
  }
</style>
</head>
<body>
  <header>
    <div class="logo">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
    <div class="spacer"></div>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ customer ‡∏î‡πâ‡∏ß‡∏¢ code ‡πÄ‡∏î‡∏¥‡∏° -->
    <button id="backToCustomer" class="btn">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Customer</button>
    <button class="btn" onclick="window.close()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
  </header>

  <main>
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h2>
      <div id="companyName" class="note"></div>

      <div class="filter-bar">
        <label for="statusFilter">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞:</label>
        <select id="statusFilter">
          <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß + ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
          <option value="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
      </div>

      <table id="noteTable">
        <thead>
          <tr>
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="color:var(--muted)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = "https://qmugpalgcktfwixqepti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdWdwYWxnY2t0ZndpeHFlcHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzI3NjcsImV4cCI6MjA3NDQ0ODc2N30.cIOCbJAr8_Gbg8d5IxpTQZKVRgl1ETN1hyBgL2_LveA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allData = [];

/* ===== Utils ===== */
function fmtDateBE(d){
  if(!d) return '-';
  const t = new Date(d);
  if(isNaN(t)) return '-';
  try{
    return t.toLocaleDateString('th-TH-u-ca-buddhist', {
      year:'numeric', month:'short', day:'numeric', timeZone:'Asia/Bangkok'
    });
  }catch{
    return `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()+543}`;
  }
}

/** ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á company_code ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ customer.html */
async function resolveCompanyCode(){
  const p = new URLSearchParams(window.location.search);
  let code = p.get('code');

  // 1) ‡∏ñ‡πâ‡∏≤ customer.html ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏°‡∏≤‡πÉ‡∏´‡πâ
  if(!code && typeof window.COMPANY_CODE === 'string'){
    code = window.COMPANY_CODE;
  }

  // 2) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage
  if(!code){
    const ls = localStorage.getItem('company_code');
    if(ls) code = ls;
  }

  // 3) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Supabase ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö code ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô user metadata
  if(!code){
    try{
      const { data } = await sb.auth.getUser();
      const metaCode = data?.user?.user_metadata?.company_code || data?.user?.app_metadata?.company_code;
      if(metaCode) code = metaCode;
    }catch(e){}
  }

  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏™‡∏ß‡∏¢ ‡πÜ
  return (code||'').trim().toUpperCase();
}

async function loadNotes(){
  const code = await resolveCompanyCode();

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ customer
  const backBtn = document.getElementById('backToCustomer');
  backBtn.onclick = ()=> {
    if(code){
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      location.href = `customer.html?code=${encodeURIComponent(code)}`;
    }else{
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (code) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô customer.html ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ ?code= ‡πÉ‡∏ô URL');
    }
  };

  if(!code){
    document.getElementById('companyName').textContent =
      '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤ (?code=...) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô (global/localStorage/Auth)';
    document.querySelector('#noteTable tbody').innerHTML =
      `<tr><td colspan="6" style="color:#b91c1c">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ customer.html ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ?code=ABC</td></tr>`;
    return;
  }

  document.getElementById('companyName').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${code}`;

  const { data, error } = await sb
    .from('product_registrations')
    .select('id,brand_name,common_label,renewed_status,renewed_note,renewed_on')
    .eq('company_code', code)
    .in('renewed_status', ['‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß'])
    .order('renewed_on', { ascending: false });

  if(error){
    document.querySelector('#noteTable tbody').innerHTML = `<tr><td colspan="6">${error.message}</td></tr>`;
    return;
  }

  allData = data || [];
  renderTable();
}

function renderTable(){
  const filter = document.getElementById('statusFilter').value;
  let filtered = allData;

  if(filter === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°'){
    filtered = allData.filter(r =>
      r.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || r.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'
    );
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    filtered.sort((a, b) => {
      if(a.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && b.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') return -1;
      if(a.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' && b.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return 1;
      return 0;
    });
  } else if(filter !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'){
    filtered = allData.filter(r => r.renewed_status === filter);
  }

  const tb = document.querySelector('#noteTable tbody');
  if(filtered.length === 0){
    tb.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map((r,i)=>`
    <tr data-status="${r.renewed_status}">
      <td>${i+1}</td>
      <td>${r.brand_name || '-'}</td>
      <td>${r.common_label || '-'}</td>
      <td><span class="status" data-status="${r.renewed_status}">${r.renewed_status}</span></td>
      <td>${r.renewed_note ? r.renewed_note.replace(/\n/g,'<br>') : '-'}</td>
      <td>${fmtDateBE(r.renewed_on)}</td>
    </tr>
  `).join('');
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadNotes();
  document.getElementById('statusFilter').addEventListener('change', renderTable);
});
</script>
</body>
</html>
